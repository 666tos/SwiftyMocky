import Foundation
import PathKit

public enum Assets {

    public enum AllTypes {
        public static let swifttemplate: AssetFile = Files.allTypes
    }
    
    public enum MockConfiguration {
        public static let swifttemplate: AssetFile = Files.mock
    }

    public enum swifttemplate {
        public static let allTypes: AssetFile = Files.allTypes
        public static let mock: AssetFile = Files.mock
    }

    public static var mockfileTemplate: String { return """
        # Mockfile is a SwiftyMocky YAML configuration file
        sourceryCommand: null
        unit.tests.mock:    # Name of your mock
          sources:
            include:        # All swift files here would be scanned for AutoMockable types
                - ./MyApp
            exclude: []     # You can exclude files as well
          output:           # Generated mock file location and name
            ./MyAppUnitTests/Mocks/Mock.generated.swift
          targets:          # Specify XCodeproj targets for your mock. Used for linting
            - MyAppUnitTests
          testable: []      # Specify  list of imported/@testable modules referenced in mock
          import: []        # You can use 'swiftymocky autoimport' to update it automatically
        """
    }
}

public protocol AssetFile {

    var name: String { get }
    var data: Data { get }

    func write(to path: Path) throws
}

private struct File: AssetFile {

    let name: String
    let contents: String
    var data: Data { return Data(base64Encoded: contents) ?? Data() }

    func write(to path: Path) throws {
        try path.write(data)
    }
}

private enum Files {
    static let allTypes = File(
        name: "AllTypes.swifttemplate",
        contents: "dHlwZXM6CjwlXyB2YXIgYWxsID0gdHlwZXMuYWxsCiAgICBhbGwgKz0gdHlwZXMucHJvdG9jb2xzLm1hcCB7ICQwIH0gLSU+CjwlXyBmb3IgdHlwZSBpbiBhbGwgeyAtJT48JV8gLSU+CiAgPCVfIGxldCBhdXRvTW9ja2FibGU6IEJvb2wgPSB0eXBlLmluaGVyaXRlZFR5cGVzLmNvbnRhaW5zKCJBdXRvTW9ja2FibGUiKSB8fCB0eXBlLmFubm90YXRpb25zWyJBdXRvTW9ja2FibGUiXSAhPSBuaWwgLSU+CiAgPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgogICAgLSA8JT0gdHlwZS5uYW1lICU+CiAgPCVfIH0gLSU+CjwlXyB9IC0lPg=="
    )
    static let mock = File(
        name: "Mock.swifttemplate",
        contents: "PCVfCmZ1bmMgc3dpZnRMaW50UnVsZXMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBzdHJpbmdBcnJheShmcm9tQXJndW1lbnRzOiBhcmd1bWVudHMsIGZvcktleTogImV4Y2x1ZGVkU3dpZnRMaW50UnVsZXMiKS5tYXAgeyBydWxlIGluCiAgICAgICAgcmV0dXJuICIvL3N3aWZ0bGludDpkaXNhYmxlIFwocnVsZSkiCiAgICB9Cn0KCmZ1bmMgcHJvamVjdEltcG9ydHMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBpbXBvcnRzKGFyZ3VtZW50cykgKyB0ZXN0YWJsZUltcG9ydHMoYXJndW1lbnRzKQp9CgpmdW5jIGltcG9ydHMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBzdHJpbmdBcnJheShmcm9tQXJndW1lbnRzOiBhcmd1bWVudHMsIGZvcktleTogImltcG9ydCIpCiAgICAgICAgLm1hcCB7IHJldHVybiAiaW1wb3J0IFwoJDApIiB9Cn0KCmZ1bmMgdGVzdGFibGVJbXBvcnRzKF8gYXJndW1lbnRzOiBbU3RyaW5nOiBBbnldKSAtPiBbU3RyaW5nXSB7CiAgICByZXR1cm4gc3RyaW5nQXJyYXkoZnJvbUFyZ3VtZW50czogYXJndW1lbnRzLCBmb3JLZXk6ICJ0ZXN0YWJsZSIpCiAgICAgICAgLm1hcCB7IHJldHVybiAiQHRlc3RhYmxlIGltcG9ydCBcKCQwKSIgfQp9CgovLy8gW0ludGVybmFsXSBHZXQgdmFsdWUgZnJvbSBkaWN0aW9uYXJ5Ci8vLyAtIFBhcmFtZXRlcnM6Ci8vLyAgIC0gZnJvbUFyZ3VtZW50czogZGljdGlvbmFyeQovLy8gICAtIGZvcktleTogZGljdGlvbmFyeSBrZXkKLy8vIC0gUmV0dXJuczogYXJyYXkgb2Ygc3RyaW5ncywgaWYga2V5IG5vdCBmb3VuZCwgcmV0dXJucyBlbXB0eSBhcnJheS4KLy8vIC0gTm90ZTogSWYgc291cmNlcnkgYXJndW1lbnRzIGNvbnRhaW50cyBvbmx5IG9uZSBlbGVtZW50LCB0aGVuIHNpbmdsZSB2YWx1ZSBpcyBzdG9yZWQsIG90aGVyd2lzZSBhcnJheSBvZiBlbGVtZW50cy4gVGhpcyBtZXRob2QgYWx3YXlzIGdldHMgYXJyYXkgb2YgZWxlbWVudHMuCmZ1bmMgc3RyaW5nQXJyYXkoZnJvbUFyZ3VtZW50cyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0sIGZvcktleSBrZXk6IFN0cmluZykgLT4gW1N0cmluZ10gewoKICAgIGlmIGxldCBhcmd1bWVudCA9IGFyZ3VtZW50c1trZXldIGFzPyBTdHJpbmcgewogICAgICAgIHJldHVybiBbYXJndW1lbnRdCiAgICB9IGVsc2UgaWYgbGV0IG1hbnlBcmd1bWVudHMgPSBhcmd1bWVudHNba2V5XSBhcz8gW1N0cmluZ10gewogICAgICAgIHJldHVybiBtYW55QXJndW1lbnRzCiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBbXQogICAgfQp9Cl8lPgovLyBHZW5lcmF0ZWQgd2l0aCBTd2lmdHlNb2NreSAzLjMuMAoKaW1wb3J0IFN3aWZ0eU1vY2t5CiNpZiBjYW5JbXBvcnQoWENUZXN0KQppbXBvcnQgWENUZXN0CiNlbmRpZgo8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gSU1QT1JUUyAtJT48JV8gLSU+CiAgICA8JV8gZm9yIHByb2plY3RJbXBvcnQgaW4gcHJvamVjdEltcG9ydHMoYXJndW1lbnQpIHsgLSU+CiAgICAgICAgPCVfICU+PCU9IHByb2plY3RJbXBvcnQgJT4KICAgIDwlXyB9IC0lPgogICAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT0gSU1QT1JUUyBJbkFQUCAoYWdncmVnYXRlZCBhcmd1bWVudCkgLSU+PCVfIC0lPgogICAgPCVfIGlmIGxldCBzd2lmdHlNb2NreUFyZ3MgPSBhcmd1bWVudFsic3dpZnR5TW9ja3kiXSBhcz8gW1N0cmluZzogQW55XSB7IC0lPgogICAgICAgIDwlXyBmb3IgcHJvamVjdEltcG9ydCBpbiBwcm9qZWN0SW1wb3J0cyhzd2lmdHlNb2NreUFyZ3MpIHsgLSU+CiAgICAgICAgICAgIDwlXyAlPjwlPSBwcm9qZWN0SW1wb3J0ICU+CiAgICAgICAgPCVfIH0gLSU+CiAgICA8JV8gfSAtJT4KPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IEFTU0VSVElPTiAtJT48JV8gLSU+CiNpZiBNb2NreUN1c3RvbQogICAgcHVibGljIGZpbmFsIGNsYXNzIE1vY2t5QXNzZXJ0aW9uIHsKICAgICAgICBwdWJsaWMgc3RhdGljIHZhciBoYW5kbGVyOiAoKEJvb2wsIFN0cmluZywgU3RhdGljU3RyaW5nLCBVSW50KSAtPiBWb2lkKT8KICAgIH0KCiAgICBmdW5jIE1vY2t5QXNzZXJ0KF8gZXhwcmVzc2lvbjogQGF1dG9jbG9zdXJlICgpIC0+IEJvb2wsIF8gbWVzc2FnZTogQGF1dG9jbG9zdXJlICgpIC0+IFN0cmluZyA9ICJWZXJpZmljYXRpb24gZmFpbGVkIiwgZmlsZTogU3RhdGljU3RyaW5nID0gI2ZpbGUsIGxpbmU6IFVJbnQgPSAjbGluZSkgewogICAgICAgIGd1YXJkIGxldCBoYW5kbGVyID0gTW9ja3lBc3NlcnRpb24uaGFuZGxlciBlbHNlIHsKICAgICAgICAgICAgYXNzZXJ0KGV4cHJlc3Npb24oKSwgbWVzc2FnZSgpLCBmaWxlOiBmaWxlLCBsaW5lOiBsaW5lKQogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGhhbmRsZXIoZXhwcmVzc2lvbigpLCBtZXNzYWdlKCksIGZpbGUsIGxpbmUpCiAgICB9CiNlbHNlCiAgICBmdW5jIE1vY2t5QXNzZXJ0KF8gZXhwcmVzc2lvbjogQGF1dG9jbG9zdXJlICgpIC0+IEJvb2wsIF8gbWVzc2FnZTogQGF1dG9jbG9zdXJlICgpIC0+IFN0cmluZyA9ICJWZXJpZmljYXRpb24gZmFpbGVkIiwgZmlsZTogU3RhdGljU3RyaW5nID0gI2ZpbGUsIGxpbmU6IFVJbnQgPSAjbGluZSkgewogICAgICAgICNpZiBjYW5JbXBvcnQoWENUZXN0KQogICAgICAgIFhDVEFzc2VydChleHByZXNzaW9uKCksIG1lc3NhZ2UoKSwgZmlsZTogZmlsZSwgbGluZTogbGluZSkKICAgICAgICAjZWxzZSAKICAgICAgICBhc3NlcnQoZXhwcmVzc2lvbigpLCBtZXNzYWdlKCksIGZpbGU6IGZpbGUsIGxpbmU6IGxpbmUpCiAgICAgICAgI2VuZGlmCiAgICB9CiNlbmRpZjwlXwpjbGFzcyBDdXJyZW50IHsKICAgIHN0YXRpYyB2YXIgc2VsZlR5cGU6IFN0cmluZyA9ICJTZWxmIgp9Ci8vIENvbGxpc2lvbiBtYW5hZ2VtZW50CmZ1bmMgYXJlVGhlcmVDb2xsaXNpb25zKGJldHdlZW4gbWV0aG9kczogW01ldGhvZFdyYXBwZXJdKSAtPiBCb29sIHsKICAgIGxldCBnaXZlblNldCA9IFNldDxTdHJpbmc+KG1ldGhvZHMubWFwKHsgJDAuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiIiwgZGVwcmVjYXRlZDogdHJ1ZSwgYW5ub3RhdGVkOiBmYWxzZSkgfSkpCiAgICBndWFyZCBnaXZlblNldC5jb3VudCA9PSBtZXRob2RzLmNvdW50IGVsc2UgeyByZXR1cm4gdHJ1ZSB9IC8vIHRoZXJlIHdvdWxkIGJlIGNvbmZsaWN0cyBpbiBHaXZlbgogICAgbGV0IHZlcmlmeVNldCA9IFNldDxTdHJpbmc+KG1ldGhvZHMubWFwKHsgJDAudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiIiwgZGVwcmVjYXRlZDogdHJ1ZSwgYW5ub3RhdGVkOiBmYWxzZSkgfSkpCiAgICBndWFyZCB2ZXJpZnlTZXQuY291bnQgPT0gbWV0aG9kcy5jb3VudCBlbHNlIHsgcmV0dXJuIHRydWUgfSAvLyB0aGVyZSB3b3VsZCBiZSBjb25mbGljdHMgaW4gVmVyaWZ5CiAgICByZXR1cm4gZmFsc2UKfQoKLy8gaGVybHBlcnMKZnVuYyB1bmlxdWVzKG1ldGhvZHM6IFtTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kXSkgLT4gW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdIHsKICAgIGZ1bmMgcmV0dXJuVHlwZVN0cmlwcGVkKF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlUmF3ID0gIlwobWV0aG9kLnJldHVyblR5cGVOYW1lKSIKICAgICAgICB2YXIgc3RyaXBwZWQ6IFN0cmluZyA9IHsKICAgICAgICAgICAgZ3VhcmQgbGV0IHJhbmdlID0gcmV0dXJuVHlwZVJhdy5yYW5nZShvZjogIndoZXJlIikgZWxzZSB7IHJldHVybiByZXR1cm5UeXBlUmF3IH0KICAgICAgICAgICAgdmFyIHN0cmlwcGVkID0gcmV0dXJuVHlwZVJhdwogICAgICAgICAgICBzdHJpcHBlZC5yZW1vdmVTdWJyYW5nZSgocmFuZ2UubG93ZXJCb3VuZCkuLi4pCiAgICAgICAgICAgIHJldHVybiBzdHJpcHBlZAogICAgICAgIH0oKQogICAgICAgIHN0cmlwcGVkID0gc3RyaXBwZWQudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiICIpKQogICAgICAgIHJldHVybiBzdHJpcHBlZAogICAgfQoKICAgIGZ1bmMgYXJlU2FtZVBhcmFtcyhfIHAxOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kUGFyYW1ldGVyLCBfIHAyOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kUGFyYW1ldGVyKSAtPiBCb29sIHsKICAgICAgICBndWFyZCBwMS5hcmd1bWVudExhYmVsID09IHAyLmFyZ3VtZW50TGFiZWwgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEubmFtZSA9PSBwMi5uYW1lIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIHAxLmFyZ3VtZW50TGFiZWwgPT0gcDIuYXJndW1lbnRMYWJlbCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS50eXBlTmFtZS5uYW1lID09IHAyLnR5cGVOYW1lLm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEuYWN0dWFsVHlwZU5hbWU/Lm5hbWUgPT0gcDIuYWN0dWFsVHlwZU5hbWU/Lm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBmdW5jIGFyZVNhbWVNZXRob2RzKF8gbTE6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QsIF8gbTI6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QpIC0+IEJvb2wgewogICAgICAgIGd1YXJkIG0xLm5hbWUgIT0gbTIubmFtZSBlbHNlIHsgcmV0dXJuIG0xLnJldHVyblR5cGVOYW1lID09IG0yLnJldHVyblR5cGVOYW1lIH0KICAgICAgICBndWFyZCBtMS5zZWxlY3Rvck5hbWUgPT0gbTIuc2VsZWN0b3JOYW1lIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIG0xLnBhcmFtZXRlcnMuY291bnQgPT0gbTIucGFyYW1ldGVycy5jb3VudCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KCiAgICAgICAgbGV0IHAxID0gbTEucGFyYW1ldGVycwogICAgICAgIGxldCBwMiA9IG0yLnBhcmFtZXRlcnMKCiAgICAgICAgZm9yIGkgaW4gMC4uPHAxLmNvdW50IHsKICAgICAgICAgICAgaWYgIWFyZVNhbWVQYXJhbXMocDFbaV0scDJbaV0pIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBtMS5yZXR1cm5UeXBlTmFtZSA9PSBtMi5yZXR1cm5UeXBlTmFtZQogICAgfQoKICAgIHJldHVybiBtZXRob2RzLnJlZHVjZShbXSwgeyAocmVzdWx0LCBlbGVtZW50KSAtPiBbU291cmNlcnlSdW50aW1lLk1ldGhvZF0gaW4KICAgICAgICBndWFyZCAhcmVzdWx0LmNvbnRhaW5zKHdoZXJlOiB7IGFyZVNhbWVNZXRob2RzKCQwLGVsZW1lbnQpIH0pIGVsc2UgeyByZXR1cm4gcmVzdWx0IH0KICAgICAgICByZXR1cm4gcmVzdWx0ICsgW2VsZW1lbnRdCiAgICB9KQp9CgpmdW5jIHVuaXF1ZXNXaXRob3V0R2VuZXJpY0NvbnN0cmFpbnRzKG1ldGhvZHM6IFtTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kXSkgLT4gW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdIHsKICAgIGZ1bmMgcmV0dXJuVHlwZVN0cmlwcGVkKF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlUmF3ID0gIlwobWV0aG9kLnJldHVyblR5cGVOYW1lKSIKICAgICAgICB2YXIgc3RyaXBwZWQ6IFN0cmluZyA9IHsKICAgICAgICAgICAgZ3VhcmQgbGV0IHJhbmdlID0gcmV0dXJuVHlwZVJhdy5yYW5nZShvZjogIndoZXJlIikgZWxzZSB7IHJldHVybiByZXR1cm5UeXBlUmF3IH0KICAgICAgICAgICAgdmFyIHN0cmlwcGVkID0gcmV0dXJuVHlwZVJhdwogICAgICAgICAgICBzdHJpcHBlZC5yZW1vdmVTdWJyYW5nZSgocmFuZ2UubG93ZXJCb3VuZCkuLi4pCiAgICAgICAgICAgIHJldHVybiBzdHJpcHBlZAogICAgICAgIH0oKQogICAgICAgIHN0cmlwcGVkID0gc3RyaXBwZWQudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiICIpKQogICAgICAgIHJldHVybiBzdHJpcHBlZAogICAgfQoKICAgIGZ1bmMgYXJlU2FtZVBhcmFtcyhfIHAxOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kUGFyYW1ldGVyLCBfIHAyOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kUGFyYW1ldGVyKSAtPiBCb29sIHsKICAgICAgICBndWFyZCBwMS5hcmd1bWVudExhYmVsID09IHAyLmFyZ3VtZW50TGFiZWwgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEubmFtZSA9PSBwMi5uYW1lIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIHAxLmFyZ3VtZW50TGFiZWwgPT0gcDIuYXJndW1lbnRMYWJlbCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS50eXBlTmFtZS5uYW1lID09IHAyLnR5cGVOYW1lLm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEuYWN0dWFsVHlwZU5hbWU/Lm5hbWUgPT0gcDIuYWN0dWFsVHlwZU5hbWU/Lm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBmdW5jIGFyZVNhbWVNZXRob2RzKF8gbTE6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QsIF8gbTI6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QpIC0+IEJvb2wgewogICAgICAgIGd1YXJkIG0xLm5hbWUgIT0gbTIubmFtZSBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVTdHJpcHBlZChtMSkgPT0gcmV0dXJuVHlwZVN0cmlwcGVkKG0yKSB9CiAgICAgICAgZ3VhcmQgbTEuc2VsZWN0b3JOYW1lID09IG0yLnNlbGVjdG9yTmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBtMS5wYXJhbWV0ZXJzLmNvdW50ID09IG0yLnBhcmFtZXRlcnMuY291bnQgZWxzZSB7IHJldHVybiBmYWxzZSB9CgogICAgICAgIGxldCBwMSA9IG0xLnBhcmFtZXRlcnMKICAgICAgICBsZXQgcDIgPSBtMi5wYXJhbWV0ZXJzCgogICAgICAgIGZvciBpIGluIDAuLjxwMS5jb3VudCB7CiAgICAgICAgICAgIGlmICFhcmVTYW1lUGFyYW1zKHAxW2ldLHAyW2ldKSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmV0dXJuVHlwZVN0cmlwcGVkKG0xKSA9PSByZXR1cm5UeXBlU3RyaXBwZWQobTIpCiAgICB9CgogICAgcmV0dXJuIG1ldGhvZHMucmVkdWNlKFtdLCB7IChyZXN1bHQsIGVsZW1lbnQpIC0+IFtTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kXSBpbgogICAgICAgIGd1YXJkICFyZXN1bHQuY29udGFpbnMod2hlcmU6IHsgYXJlU2FtZU1ldGhvZHMoJDAsZWxlbWVudCkgfSkgZWxzZSB7IHJldHVybiByZXN1bHQgfQogICAgICAgIHJldHVybiByZXN1bHQgKyBbZWxlbWVudF0KICAgIH0pCn0KCmZ1bmMgdW5pcXVlcyh2YXJpYWJsZXM6IFtTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGVdKSAtPiBbU291cmNlcnlSdW50aW1lLlZhcmlhYmxlXSB7CiAgICByZXR1cm4gdmFyaWFibGVzLnJlZHVjZShbXSwgeyAocmVzdWx0LCBlbGVtZW50KSAtPiBbU291cmNlcnlSdW50aW1lLlZhcmlhYmxlXSBpbgogICAgICAgIGd1YXJkICFyZXN1bHQuY29udGFpbnMod2hlcmU6IHsgJDAubmFtZSA9PSBlbGVtZW50Lm5hbWUgfSkgZWxzZSB7IHJldHVybiByZXN1bHQgfQogICAgICAgIHJldHVybiByZXN1bHQgKyBbZWxlbWVudF0KICAgIH0pCn0KCmZ1bmMgd3JhcE1ldGhvZChfIG1ldGhvZDogU291cmNlcnlSdW50aW1lLk1ldGhvZCkgLT4gTWV0aG9kV3JhcHBlciB7CiAgICByZXR1cm4gTWV0aG9kV3JhcHBlcihtZXRob2QpCn0KCmZ1bmMgd3JhcFN1YnNjcmlwdChfIHdyYXBwZWQ6IFNvdXJjZXJ5UnVudGltZS5TdWJzY3JpcHQpIC0+IFN1YnNjcmlwdFdyYXBwZXIgewogICAgcmV0dXJuIFN1YnNjcmlwdFdyYXBwZXIod3JhcHBlZCkKfQoKZnVuYyBqdXN0V3JhcChfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIC0+IFZhcmlhYmxlV3JhcHBlciB7IHJldHVybiB3cmFwUHJvcGVydHkodmFyaWFibGUpIH0KZnVuYyB3cmFwUHJvcGVydHkoXyB2YXJpYWJsZTogU291cmNlcnlSdW50aW1lLlZhcmlhYmxlLCBfIHNjb3BlOiBTdHJpbmcgPSAiIikgLT4gVmFyaWFibGVXcmFwcGVyIHsKICAgIHJldHVybiBWYXJpYWJsZVdyYXBwZXIodmFyaWFibGUsIHNjb3BlOiBzY29wZSkKfQoKZnVuYyBzdHViUHJvcGVydHkoXyB2YXJpYWJsZTogU291cmNlcnlSdW50aW1lLlZhcmlhYmxlLCBfIHNjb3BlOiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6IHNjb3BlKQogICAgcmV0dXJuICJcKHdyYXBwZXIucHJvdG90eXBlKVxuXHRcKHdyYXBwZXIucHJpdmF0ZVByb3RvdHlwZSkiCn0KCmZ1bmMgcHJvcGVydHlUeXBlcyhfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIC0+IFN0cmluZyB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6ICJzY29wZSIpCiAgICByZXR1cm4gIlwod3JhcHBlci5wcm9wZXJ0eUdldCgpKSIgKyAod3JhcHBlci5yZWFkb25seSA/ICIiIDogIlxuXHRcdFwod3JhcHBlci5wcm9wZXJ0eVNldCgpKSIpCn0KCmZ1bmMgcHJvcGVydHlNZXRob2RUeXBlcyhfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIC0+IFN0cmluZyB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6ICIiKQogICAgcmV0dXJuICJcKHdyYXBwZXIucHJvcGVydHlDYXNlR2V0KCkpIiArICh3cmFwcGVyLnJlYWRvbmx5ID8gIiIgOiAiXG5cdFx0XCh3cmFwcGVyLnByb3BlcnR5Q2FzZVNldCgpKSIpCn0KCmZ1bmMgcHJvcGVydHlNZXRob2RUeXBlc0NvbXBhcmUoXyB2YXJpYWJsZTogU291cmNlcnlSdW50aW1lLlZhcmlhYmxlKSAtPiBTdHJpbmcgewogICAgbGV0IHdyYXBwZXIgPSBWYXJpYWJsZVdyYXBwZXIodmFyaWFibGUsIHNjb3BlOiAiIikKICAgIHJldHVybiAiXCh3cmFwcGVyLnByb3BlcnR5Q2FzZUdldENvbXBhcmUoKSkiICsgKHdyYXBwZXIucmVhZG9ubHkgPyAiIiA6ICJcblx0XHRcdFwod3JhcHBlci5wcm9wZXJ0eUNhc2VTZXRDb21wYXJlKCkpIikKfQoKZnVuYyBwcm9wZXJ0eU1ldGhvZFR5cGVzSW50VmFsdWUoXyB2YXJpYWJsZTogU291cmNlcnlSdW50aW1lLlZhcmlhYmxlKSAtPiBTdHJpbmcgewogICAgbGV0IHdyYXBwZXIgPSBWYXJpYWJsZVdyYXBwZXIodmFyaWFibGUsIHNjb3BlOiAiIikKICAgIHJldHVybiAiXCh3cmFwcGVyLnByb3BlcnR5Q2FzZUdldEludFZhbHVlKCkpIiArICh3cmFwcGVyLnJlYWRvbmx5ID8gIiIgOiAiXG5cdFx0XHRcKHdyYXBwZXIucHJvcGVydHlDYXNlU2V0SW50VmFsdWUoKSkiKQp9CgpmdW5jIHByb3BlcnR5UmVnaXN0ZXIoXyB2YXJpYWJsZTogU291cmNlcnlSdW50aW1lLlZhcmlhYmxlKSB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6ICIiKQogICAgTWV0aG9kV3JhcHBlci5yZWdpc3Rlcih3cmFwcGVyLnByb3BlcnR5Q2FzZUdldE5hbWUsd3JhcHBlci5wcm9wZXJ0eUNhc2VHZXROYW1lLHdyYXBwZXIucHJvcGVydHlDYXNlR2V0TmFtZSkKICAgIGd1YXJkICF3cmFwcGVyLnJlYWRvbmx5IGVsc2UgeyByZXR1cm4gfQogICAgTWV0aG9kV3JhcHBlci5yZWdpc3Rlcih3cmFwcGVyLnByb3BlcnR5Q2FzZVNldE5hbWUsd3JhcHBlci5wcm9wZXJ0eUNhc2VTZXROYW1lLHdyYXBwZXIucHJvcGVydHlDYXNlR2V0TmFtZSkKfQpjbGFzcyBIZWxwZXJzIHsKICAgIHN0YXRpYyBmdW5jIHNwbGl0KF8gc3RyaW5nOiBTdHJpbmcsIGJ5Rmlyc3RPY2N1cmVuY2VPZiB3b3JkOiBTdHJpbmcpIC0+IChTdHJpbmcsIFN0cmluZykgewogICAgICAgIGd1YXJkIGxldCB3b3JkUmFuZ2UgPSBzdHJpbmcucmFuZ2Uob2Y6IHdvcmQpIGVsc2UgeyByZXR1cm4gKHN0cmluZywgIiIpIH0KICAgICAgICBsZXQgc2VsZlJhbmdlID0gc3RyaW5nLnJhbmdlKG9mOiBzdHJpbmcpIQogICAgICAgIGxldCBiZWZvcmUgPSBTdHJpbmcoc3RyaW5nW3NlbGZSYW5nZS5sb3dlckJvdW5kLi48d29yZFJhbmdlLmxvd2VyQm91bmRdKQogICAgICAgIGxldCBhZnRlciA9IFN0cmluZyhzdHJpbmdbd29yZFJhbmdlLnVwcGVyQm91bmQuLjxzZWxmUmFuZ2UudXBwZXJCb3VuZF0pCiAgICAgICAgcmV0dXJuIChiZWZvcmUsIGFmdGVyKQogICAgfQogICAgc3RhdGljIGZ1bmMgZXh0cmFjdEFzc29jaWF0ZWRUeXBlcyhmcm9tIGFubm90YXRlZDogU291cmNlcnlSdW50aW1lLkFubm90YXRlZCkgLT4gW1N0cmluZ10/IHsKICAgICAgICBpZiBsZXQgdHlwZXMgPSBhbm5vdGF0ZWQuYW5ub3RhdGlvbnNbImFzc29jaWF0ZWR0eXBlIl0gYXM/IFtTdHJpbmddIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVzLnJldmVyc2VkKCkKICAgICAgICB9IGVsc2UgaWYgbGV0IHR5cGUgPSBhbm5vdGF0ZWQuYW5ub3RhdGlvbnNbImFzc29jaWF0ZWR0eXBlIl0gYXM/IFN0cmluZyB7CiAgICAgICAgICAgIHJldHVybiBbdHlwZV0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbmlsCiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGZ1bmMgZXh0cmFjdEdlbmVyaWNzTGlzdChfIGFzc29jaWF0ZWRUeXBlczogW1N0cmluZ10/KSAtPiBbU3RyaW5nXSB7CiAgICAgICAgcmV0dXJuIGFzc29jaWF0ZWRUeXBlcz8uZmxhdE1hcCB7CiAgICAgICAgICAgIHNwbGl0KCQwLCBieUZpcnN0T2NjdXJlbmNlT2Y6ICIgd2hlcmUgIikuMC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiAiLCB3aXRoOiAiIikuY2hhcmFjdGVycy5zcGxpdChzZXBhcmF0b3I6ICI6IikubWFwKFN0cmluZy5pbml0KS5maXJzdAogICAgICAgICAgICB9Lm1hcCB7ICJcKCQwKSIgfSA/PyBbXQogICAgfQogICAgc3RhdGljIGZ1bmMgZXh0cmFjdEdlbmVyaWNUeXBlc01vZGlmaWVyKF8gYXNzb2NpYXRlZFR5cGVzOiBbU3RyaW5nXT8pIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGFsbCA9IGV4dHJhY3RHZW5lcmljc0xpc3QoYXNzb2NpYXRlZFR5cGVzKQogICAgICAgIGd1YXJkICFhbGwuaXNFbXB0eSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIjxcKGFsbC5qb2luZWQoc2VwYXJhdG9yOiAiLCIpKT4iCiAgICB9CiAgICBzdGF0aWMgZnVuYyBleHRyYWN0R2VuZXJpY1R5cGVzQ29uc3RyYWludHMoXyBhc3NvY2lhdGVkVHlwZXM6IFtTdHJpbmddPykgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCBsZXQgYWxsID0gYXNzb2NpYXRlZFR5cGVzIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCBjb25zdHJhaW50cyA9IGFsbC5mbGF0TWFwIHsgdCAtPiBTdHJpbmc/IGluCiAgICAgICAgICAgIGxldCBzcGxpdHRlZCA9IHNwbGl0KHQsIGJ5Rmlyc3RPY2N1cmVuY2VPZjogIiB3aGVyZSAiKQogICAgICAgICAgICBsZXQgY29uc3RyYWludCA9IHNwbGl0dGVkLjAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgIiwgd2l0aDogIiIpLmNoYXJhY3RlcnMuc3BsaXQoc2VwYXJhdG9yOiAiOiIpLm1hcChTdHJpbmcuaW5pdCkKICAgICAgICAgICAgZ3VhcmQgY29uc3RyYWludC5jb3VudCA9PSAyIGVsc2UgeyByZXR1cm4gbmlsIH0KICAgICAgICAgICAgbGV0IGFkb3B0cyA9IGNvbnN0cmFpbnRbMV0uY2hhcmFjdGVycy5zcGxpdChzZXBhcmF0b3I6ICIsIikubWFwKFN0cmluZy5pbml0KQogICAgICAgICAgICB2YXIgbWFwcGVkID0gYWRvcHRzLm1hcCB7ICJcKGNvbnN0cmFpbnRbMF0pOiBcKCQwKSIgfQogICAgICAgICAgICBpZiAhc3BsaXR0ZWQuMS5pc0VtcHR5IHsKICAgICAgICAgICAgICAgIG1hcHBlZC5hcHBlbmQoc3BsaXR0ZWQuMSkKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWFwcGVkLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgZ3VhcmQgIWNvbnN0cmFpbnRzLmlzRW1wdHkgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgcmV0dXJuICIgd2hlcmUgXChjb25zdHJhaW50cykiCiAgICB9Cn0KY2xhc3MgUGFyYW1ldGVyV3JhcHBlciB7CiAgICBsZXQgcGFyYW1ldGVyOiBNZXRob2RQYXJhbWV0ZXIKCiAgICB2YXIgd3JhcHBlZEZvckNhbGw6IFN0cmluZyB7CiAgICAgICAgbGV0IHR5cGVTdHJpbmcgPSAiXCh0eXBlLmFjdHVhbFR5cGVOYW1lID8/IHR5cGUpIgogICAgICAgIGxldCBpc0VzY2FwaW5nID0gdHlwZVN0cmluZy5jb250YWlucygiQGVzY2FwaW5nIikKICAgICAgICBsZXQgaXNPcHRpb25hbCA9ICh0eXBlLmFjdHVhbFR5cGVOYW1lID8/IHR5cGUpLmlzT3B0aW9uYWwKICAgICAgICBpZiBwYXJhbWV0ZXIuaXNDbG9zdXJlICYmICFpc0VzY2FwaW5nICYmICFpc09wdGlvbmFsIHsKICAgICAgICAgICAgcmV0dXJuICJcKG5lc3RlZFR5cGUpLmFueSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwobmVzdGVkVHlwZSkudmFsdWUoXChlc2NhcGVkTmFtZSkpIgogICAgICAgIH0KICAgIH0KICAgIHZhciB3cmFwcGVkVHlwZTogU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlBhcmFtZXRlcjxcKFR5cGVXcmFwcGVyKHR5cGUpLnN0cmlwcGVkKT4iCiAgICB9CiAgICB2YXIgbmVzdGVkVHlwZTogU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwoVHlwZVdyYXBwZXIodHlwZSkubmVzdGVkUGFyYW1ldGVyKSIKICAgIH0KICAgIHZhciBqdXN0VHlwZTogU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwoVHlwZVdyYXBwZXIodHlwZSkucmVwbGFjaW5nU2VsZigpKSIKICAgIH0KICAgIHZhciBqdXN0UGVyZm9ybVR5cGU6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJcKFR5cGVXcmFwcGVyKHR5cGUpLnJlcGxhY2luZ1NlbGYoKSkiLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiISIsIHdpdGg6ICI/IikKICAgIH0KICAgIHZhciBnZW5lcmljVHlwZTogU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlBhcmFtZXRlcjxHZW5lcmljQXR0cmlidXRlPiIKICAgIH0KICAgIHZhciB0eXBlOiBTb3VyY2VyeVJ1bnRpbWUuVHlwZU5hbWUgewogICAgICAgIHJldHVybiBwYXJhbWV0ZXIudHlwZU5hbWUKICAgIH0KICAgIHZhciBuYW1lOiBTdHJpbmcgewogICAgICAgIHJldHVybiBwYXJhbWV0ZXIubmFtZQogICAgfQogICAgdmFyIGVzY2FwZWROYW1lOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiYFwocGFyYW1ldGVyLm5hbWUpYCIKICAgIH0KICAgIHZhciBjb21wYXJhdG9yOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiZ3VhcmQgUGFyYW1ldGVyLmNvbXBhcmUobGhzOiBsaHNcKHBhcmFtZXRlci5uYW1lLmNhcGl0YWxpemVkKSwgcmhzOiByaHNcKHBhcmFtZXRlci5uYW1lLmNhcGl0YWxpemVkKSwgd2l0aDogbWF0Y2hlcikgZWxzZSB7IHJldHVybiBmYWxzZSB9IgogICAgfQoKICAgIGluaXQoXyBwYXJhbWV0ZXI6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIpIHsKICAgICAgICBzZWxmLnBhcmFtZXRlciA9IHBhcmFtZXRlcgogICAgfQoKICAgIGZ1bmMgaXNHZW5lcmljKF8gdHlwZXM6IFtTdHJpbmddKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gVHlwZVdyYXBwZXIodHlwZSkuaXNHZW5lcmljKHR5cGVzKQogICAgfQoKICAgIGZ1bmMgd3JhcHBlZEZvclByb3h5KF8gZ2VuZXJpY3M6IFtTdHJpbmddKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiBpc0dlbmVyaWMoZ2VuZXJpY3MpID8gIlwoZXNjYXBlZE5hbWUpLndyYXBBc0dlbmVyaWMoKSIgOiAiXChlc2NhcGVkTmFtZSkiCiAgICB9CiAgICBmdW5jIHdyYXBwZWRGb3JDYWxscyhfIGdlbmVyaWNzOiBbU3RyaW5nXSkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gaXNHZW5lcmljKGdlbmVyaWNzKSA/ICJcKHdyYXBwZWRGb3JDYWxsKS53cmFwQXNHZW5lcmljKCkiIDogIlwod3JhcHBlZEZvckNhbGwpIgogICAgfQoKICAgIGZ1bmMgYXNNZXRob2RBcmd1bWVudCgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJcKHBhcmFtZXRlci5hcmd1bWVudExhYmVsID8/ICJfIikgXChwYXJhbWV0ZXIubmFtZSk6IFwocGFyYW1ldGVyLnR5cGVOYW1lKSIKICAgIH0KICAgIGZ1bmMgbGFiZWxBbmROYW1lKCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgbGFiZWwgPSBwYXJhbWV0ZXIuYXJndW1lbnRMYWJlbCA/PyAiXyIKICAgICAgICByZXR1cm4gbGFiZWwgIT0gIlwocGFyYW1ldGVyLm5hbWUpIiA/ICJcKGxhYmVsKSBcKHBhcmFtZXRlci5uYW1lKSIgOiBsYWJlbAogICAgfQogICAgZnVuYyBzYW5pdGl6ZWRGb3JFbnVtQ2FzZU5hbWUoKSAtPiBTdHJpbmcgewogICAgICAgIGlmIGxldCBsYWJlbCA9IHBhcmFtZXRlci5hcmd1bWVudExhYmVsIHsKICAgICAgICAgICAgcmV0dXJuICJcKGxhYmVsKV9cKHBhcmFtZXRlci5uYW1lKSIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJgIiwgd2l0aDogIiIpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJcKHBhcmFtZXRlci5uYW1lKSIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJgIiwgd2l0aDogIiIpCiAgICAgICAgfQogICAgfQp9CmNsYXNzIFR5cGVXcmFwcGVyIHsKICAgIGxldCB0eXBlOiBTb3VyY2VyeVJ1bnRpbWUuVHlwZU5hbWUKCiAgICB2YXIgdW53cmFwcGVkOiBTdHJpbmcgewogICAgICAgIHJldHVybiB0eXBlLnVud3JhcHBlZFR5cGVOYW1lCiAgICB9CiAgICB2YXIgdW53cmFwcGVkUmVwbGFjaW5nU2VsZjogU3RyaW5nIHsKICAgICAgICByZXR1cm4gcmVwbGFjaW5nU2VsZih1bndyYXA6IHRydWUpCiAgICB9CiAgICB2YXIgc3RyaXBwZWQ6IFN0cmluZyB7CiAgICAgICAgaWYgdHlwZS5pc0ltcGxpY2l0bHlVbndyYXBwZWRPcHRpb25hbCB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmlzQ2xvc3VyZSA/ICIoXCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKSk/IiA6ICJcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpPyIKICAgICAgICB9IGVsc2UgaWYgdHlwZS5pc09wdGlvbmFsIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuaXNDbG9zdXJlID8gIihcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpKT8iIDogIlwodW53cmFwcGVkUmVwbGFjaW5nU2VsZik/IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB1bndyYXBwZWRSZXBsYWNpbmdTZWxmCiAgICAgICAgfQogICAgfQogICAgdmFyIG5lc3RlZFBhcmFtZXRlcjogU3RyaW5nIHsKICAgICAgICBpZiB0eXBlLmlzSW1wbGljaXRseVVud3JhcHBlZE9wdGlvbmFsIHsKICAgICAgICAgICAgcmV0dXJuICJQYXJhbWV0ZXI8IiArICh0eXBlLmlzQ2xvc3VyZSA/ICIoXCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKSk/IiA6ICJcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpPyIpICsgIj4iCiAgICAgICAgfSBlbHNlIGlmIHR5cGUuaXNPcHRpb25hbCB7CiAgICAgICAgICAgIHJldHVybiAiUGFyYW1ldGVyPCIgKyAodHlwZS5pc0Nsb3N1cmUgPyAiKFwodW53cmFwcGVkUmVwbGFjaW5nU2VsZikpPyIgOiAiXCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKT8iKSArICI+IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiUGFyYW1ldGVyPFwodW53cmFwcGVkUmVwbGFjaW5nU2VsZik+IgogICAgICAgIH0KICAgIH0KICAgIHZhciBpc1NlbGZUeXBlOiBCb29sIHsKICAgICAgICByZXR1cm4gdW53cmFwcGVkID09ICJTZWxmIgogICAgfQogICAgZnVuYyBpc1NlbGZUeXBlUmVjdXJzaXZlKCkgLT4gQm9vbCB7CiAgICAgICAgaWYgbGV0IHR1cGxlID0gdHlwZS50dXBsZSB7CiAgICAgICAgICAgIGZvciBlbGVtZW50IGluIHR1cGxlLmVsZW1lbnRzIHsKICAgICAgICAgICAgICAgIGd1YXJkICFUeXBlV3JhcHBlcihlbGVtZW50LnR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiBsZXQgYXJyYXkgPSB0eXBlLmFycmF5IHsKICAgICAgICAgICAgcmV0dXJuIFR5cGVXcmFwcGVyKGFycmF5LmVsZW1lbnRUeXBlTmFtZSkuaXNTZWxmVHlwZVJlY3Vyc2l2ZSgpCiAgICAgICAgfSBlbHNlIGlmIGxldCBkaWN0aW9uYXJ5ID0gdHlwZS5kaWN0aW9uYXJ5IHsKICAgICAgICAgICAgZ3VhcmQgIVR5cGVXcmFwcGVyKGRpY3Rpb25hcnkudmFsdWVUeXBlTmFtZSkuaXNTZWxmVHlwZVJlY3Vyc2l2ZSgpIGVsc2UgeyByZXR1cm4gdHJ1ZSB9CiAgICAgICAgICAgIGd1YXJkICFUeXBlV3JhcHBlcihkaWN0aW9uYXJ5LmtleVR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICB9IGVsc2UgaWYgbGV0IGNsb3N1cmUgPSB0eXBlLmNsb3N1cmUgewogICAgICAgICAgICBndWFyZCAhVHlwZVdyYXBwZXIoY2xvc3VyZS5hY3R1YWxSZXR1cm5UeXBlTmFtZSkuaXNTZWxmVHlwZVJlY3Vyc2l2ZSgpIGVsc2UgeyByZXR1cm4gdHJ1ZSB9CiAgICAgICAgICAgIGZvciBwYXJhbWV0ZXIgaW4gY2xvc3VyZS5wYXJhbWV0ZXJzIHsKICAgICAgICAgICAgICAgIGd1YXJkICFUeXBlV3JhcHBlcihwYXJhbWV0ZXIudHlwZU5hbWUpLmlzU2VsZlR5cGVSZWN1cnNpdmUoKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNTZWxmVHlwZQogICAgfQoKICAgIGluaXQoXyB0eXBlOiBTb3VyY2VyeVJ1bnRpbWUuVHlwZU5hbWUpIHsKICAgICAgICBzZWxmLnR5cGUgPSB0eXBlCiAgICB9CgogICAgZnVuYyBpc0dlbmVyaWMoXyB0eXBlczogW1N0cmluZ10pIC0+IEJvb2wgewogICAgICAgIGd1YXJkICF0eXBlLmlzVm9pZCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KCiAgICAgICAgcmV0dXJuIGlzR2VuZXJpYyhuYW1lOiB1bndyYXBwZWQsIGdlbmVyaWNzOiB0eXBlcykKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgaXNHZW5lcmljKG5hbWU6IFN0cmluZywgZ2VuZXJpY3M6IFtTdHJpbmddKSAtPiBCb29sIHsKICAgICAgICBsZXQgbmFtZSA9ICIoXChuYW1lLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiICIsIHdpdGg6ICIiKSkpIgogICAgICAgIGxldCBtb2RpZmllcnMgPSAiW1xcP1xcIV0qIgogICAgICAgIHJldHVybiBnZW5lcmljcy5jb250YWlucyh3aGVyZTogeyBnZW5lcmljIGluCiAgICAgICAgICAgIGxldCB3cmFwcGVkID0gIihbXFwoXVwoZ2VuZXJpYylcKG1vZGlmaWVycylbXFwpXFwuXSkiCiAgICAgICAgICAgIGxldCBjb25zdHJhaW50ID0gIihbPCxdXChnZW5lcmljKVwobW9kaWZpZXJzKVs+LFxcLl0pIgogICAgICAgICAgICBsZXQgYXJyYXlzID0gIihbXFxbOl1cKGdlbmVyaWMpXChtb2RpZmllcnMpW1xcXSxcXC46XSkiCiAgICAgICAgICAgIGxldCB0dXBsZXMgPSAiKFtcXCgsXVwoZ2VuZXJpYylcKG1vZGlmaWVycylbLFxcLlxcKV0pIgogICAgICAgICAgICBsZXQgY2xvc3VyZXMgPSAiKChcXC1cXD4pXChnZW5lcmljKVwobW9kaWZpZXJzKVssXFwuXFwpXSkiCiAgICAgICAgICAgIGxldCBwYXR0ZXJuID0gIlwod3JhcHBlZCl8XChjb25zdHJhaW50KXxcKGFycmF5cyl8XCh0dXBsZXMpfFwoY2xvc3VyZXMpIgogICAgICAgICAgICBndWFyZCBsZXQgcmVnZXggPSB0cnk/IE5TUmVndWxhckV4cHJlc3Npb24ocGF0dGVybjogcGF0dGVybikgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgICAgIHJldHVybiByZWdleC5maXJzdE1hdGNoKGluOiBuYW1lLCBvcHRpb25zOiBbXSwgcmFuZ2U6IE5TUmFuZ2UobG9jYXRpb246IDAsIGxlbmd0aDogKG5hbWUgYXMgTlNTdHJpbmcpLmxlbmd0aCkpICE9IG5pbAogICAgICAgIH0pCiAgICB9CgogICAgZnVuYyByZXBsYWNpbmdTZWxmKHVud3JhcDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIGd1YXJkIGlzU2VsZlR5cGVSZWN1cnNpdmUoKSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHVud3JhcCA/IHNlbGYudW53cmFwcGVkIDogIlwodHlwZSkiCiAgICAgICAgfQoKICAgICAgICBpZiBpc1NlbGZUeXBlIHsKICAgICAgICAgICAgbGV0IG9wdGlvbmFsaXR5OiBTdHJpbmcgPSB7CiAgICAgICAgICAgICAgICBpZiB0eXBlLmlzSW1wbGljaXRseVVud3JhcHBlZE9wdGlvbmFsIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIiEiCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgdHlwZS5pc09wdGlvbmFsIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIj8iCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KCkKICAgICAgICAgICAgcmV0dXJuIHVud3JhcCA/IEN1cnJlbnQuc2VsZlR5cGUgOiBDdXJyZW50LnNlbGZUeXBlICsgb3B0aW9uYWxpdHkKICAgICAgICB9IGVsc2UgaWYgbGV0IHR1cGxlID0gdHlwZS50dXBsZSB7CiAgICAgICAgICAgIGxldCBpbm5lciA9IHR1cGxlLmVsZW1lbnRzLm1hcCh7IFR5cGVXcmFwcGVyKCQwLnR5cGVOYW1lKS5yZXBsYWNpbmdTZWxmKCkgfSkuam9pbmVkKHNlcGFyYXRvcjogIiwiKQogICAgICAgICAgICBsZXQgdmFsdWUgPSAiKFwoaW5uZXIpKSIKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgfSBlbHNlIGlmIGxldCBhcnJheSA9IHR5cGUuYXJyYXkgewogICAgICAgICAgICBsZXQgdmFsdWUgPSAiW1woVHlwZVdyYXBwZXIoYXJyYXkuZWxlbWVudFR5cGVOYW1lKS5yZXBsYWNpbmdTZWxmKCkpXSIKICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgfSBlbHNlIGlmIGxldCBkaWN0aW9uYXJ5ID0gdHlwZS5kaWN0aW9uYXJ5IHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gIlsiICsKICAgICAgICAgICAgICAgICJcKFR5cGVXcmFwcGVyKGRpY3Rpb25hcnkudmFsdWVUeXBlTmFtZSkucmVwbGFjaW5nU2VsZigpKSIKICAgICAgICAgICAgICAgICsgIjoiICsKICAgICAgICAgICAgICAgICJcKFR5cGVXcmFwcGVyKGRpY3Rpb25hcnkua2V5VHlwZU5hbWUpLnJlcGxhY2luZ1NlbGYoKSkiCiAgICAgICAgICAgICAgICArICJdIgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB9IGVsc2UgaWYgbGV0IGNsb3N1cmUgPSB0eXBlLmNsb3N1cmUgewogICAgICAgICAgICBsZXQgcmV0dXJuVHlwZSA9IFR5cGVXcmFwcGVyKGNsb3N1cmUuYWN0dWFsUmV0dXJuVHlwZU5hbWUpLnJlcGxhY2luZ1NlbGYoKQogICAgICAgICAgICBsZXQgaW5uZXIgPSBjbG9zdXJlLnBhcmFtZXRlcnMubWFwKHsgVHlwZVdyYXBwZXIoJDAudHlwZU5hbWUpLnJlcGxhY2luZ1NlbGYoKSB9KS5qb2luZWQoc2VwYXJhdG9yOiAiLCIpCiAgICAgICAgICAgIGxldCB0aHJvd2luZyA9IGNsb3N1cmUudGhyb3dzID8gInRocm93cyAiIDogIiIKICAgICAgICAgICAgbGV0IHZhbHVlID0gIihcKGlubmVyKSkgXCh0aHJvd2luZyktPiBcKHJldHVyblR5cGUpIgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gKHVud3JhcCA/IHNlbGYudW53cmFwcGVkIDogIlwodHlwZSkiKQogICAgICAgIH0KICAgIH0KfQpmdW5jIHJlcGxhY2luZ1NlbGYoXyB2YWx1ZTogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgcmV0dXJuIHZhbHVlCiAgICAgICAgLy8gVE9ETzogcHJvcGVyIHJlZ2V4IGhlcmUKICAgICAgICAvLyBkZWZhdWx0IDwgY2FzZSA+CiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiPFNlbGY+Iiwgd2l0aDogIjxcKEN1cnJlbnQuc2VsZlR5cGUpPiIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiPFNlbGYgIiwgd2l0aDogIjxcKEN1cnJlbnQuc2VsZlR5cGUpICIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiPFNlbGYuIiwgd2l0aDogIjxcKEN1cnJlbnQuc2VsZlR5cGUpLiIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiPFNlbGYsIiwgd2l0aDogIjxcKEN1cnJlbnQuc2VsZlR5cGUpLCIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiPFNlbGY/Iiwgd2l0aDogIjxcKEN1cnJlbnQuc2VsZlR5cGUpPyIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiIFNlbGY+Iiwgd2l0aDogIiBcKEN1cnJlbnQuc2VsZlR5cGUpPiIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiLFNlbGY+Iiwgd2l0aDogIixcKEN1cnJlbnQuc2VsZlR5cGUpPiIpCiAgICAgICAgLy8gKFNlbGYpIC0+IENhc2UKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoU2VsZikiLCB3aXRoOiAiKFwoQ3VycmVudC5zZWxmVHlwZSkpIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoU2VsZiAiLCB3aXRoOiAiKFwoQ3VycmVudC5zZWxmVHlwZSkgIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoU2VsZi4iLCB3aXRoOiAiKFwoQ3VycmVudC5zZWxmVHlwZSkuIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoU2VsZiwiLCB3aXRoOiAiKFwoQ3VycmVudC5zZWxmVHlwZSksIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoU2VsZj8iLCB3aXRoOiAiKFwoQ3VycmVudC5zZWxmVHlwZSk/IikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZikiLCB3aXRoOiAiIFwoQ3VycmVudC5zZWxmVHlwZSkpIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIsU2VsZikiLCB3aXRoOiAiLFwoQ3VycmVudC5zZWxmVHlwZSkpIikKICAgICAgICAvLyBsaXRlcmFscwogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIltTZWxmXSIsIHdpdGg6ICJbXChDdXJyZW50LnNlbGZUeXBlKV0iKQogICAgICAgIC8vIHJpZ2h0CiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGYgIiwgd2l0aDogIltcKEN1cnJlbnQuc2VsZlR5cGUpICIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGYuIiwgd2l0aDogIltcKEN1cnJlbnQuc2VsZlR5cGUpLiIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGYsIiwgd2l0aDogIltcKEN1cnJlbnQuc2VsZlR5cGUpLCIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGY6Iiwgd2l0aDogIltcKEN1cnJlbnQuc2VsZlR5cGUpOiIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGY/Iiwgd2l0aDogIltcKEN1cnJlbnQuc2VsZlR5cGUpPyIpCiAgICAgICAgLy8gbGVmdAogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiBTZWxmXSIsIHdpdGg6ICIgXChDdXJyZW50LnNlbGZUeXBlKV0iKQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIixTZWxmXSIsIHdpdGg6ICIsXChDdXJyZW50LnNlbGZUeXBlKV0iKQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIjpTZWxmXSIsIHdpdGg6ICI6XChDdXJyZW50LnNlbGZUeXBlKV0iKQogICAgICAgIC8vIHVua25vd24KICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZiAiLCB3aXRoOiAiIFwoQ3VycmVudC5zZWxmVHlwZSkgIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZi4iLCB3aXRoOiAiIFwoQ3VycmVudC5zZWxmVHlwZSkuIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZiwiLCB3aXRoOiAiIFwoQ3VycmVudC5zZWxmVHlwZSksIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZjoiLCB3aXRoOiAiIFwoQ3VycmVudC5zZWxmVHlwZSk6IikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZj8iLCB3aXRoOiAiIFwoQ3VycmVudC5zZWxmVHlwZSk/IikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIsU2VsZiAiLCB3aXRoOiAiLFwoQ3VycmVudC5zZWxmVHlwZSkgIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIsU2VsZiwiLCB3aXRoOiAiLFwoQ3VycmVudC5zZWxmVHlwZSksIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIsU2VsZj8iLCB3aXRoOiAiLFwoQ3VycmVudC5zZWxmVHlwZSk/IikKfQoKY2xhc3MgTWV0aG9kV3JhcHBlciB7CiAgICBwcml2YXRlIGZ1bmMgZGVwcmVjYXRlZE1lc3NhZ2UoXyBwcmVmZXJyZWQ6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiQGF2YWlsYWJsZSgqLCBkZXByZWNhdGVkLCBtZXNzYWdlOiBcIlRoaXMgY29uc3RydWN0b3IgaXMgZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB2My4xXChwcmVmZXJyZWQpXCIpXG5cdFx0IgogICAgfQogICAgcHJpdmF0ZSB2YXIgbm9TdHViRGVmaW5lZE1lc3NhZ2U6IFN0cmluZyB7IHJldHVybiAiU3R1YiByZXR1cm4gdmFsdWUgbm90IHNwZWNpZmllZCBmb3IgXChtZXRob2QubmFtZSkuIFVzZSBnaXZlbiIgfQoKICAgIHByaXZhdGUgc3RhdGljIHZhciByZWdpc3RlcmVkOiBbU3RyaW5nOiBJbnRdID0gWzpdCiAgICBwcml2YXRlIHN0YXRpYyB2YXIgc3VmZml4ZXM6IFtTdHJpbmc6IEludF0gPSBbOl0KICAgIHByaXZhdGUgc3RhdGljIHZhciBzdWZmaXhlc1dpdGhvdXRSZXR1cm5UeXBlOiBbU3RyaW5nOiBJbnRdID0gWzpdCgogICAgbGV0IG1ldGhvZDogU291cmNlcnlSdW50aW1lLk1ldGhvZAogICAgdmFyIGFjY2Vzc01vZGlmaWVyOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNTdGF0aWMgZWxzZSB7IHJldHVybiAicHVibGljIHN0YXRpYyIgfQogICAgICAgIGd1YXJkICFyZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmIGVsc2UgeyByZXR1cm4gInB1YmxpYyIgfQogICAgICAgIHJldHVybiAib3BlbiIKICAgIH0KCiAgICBwcml2YXRlIHZhciByZWdpc3RyYXRpb25OYW1lOiBTdHJpbmcgewogICAgICAgIHZhciByYXdOYW1lID0gKG1ldGhvZC5pc1N0YXRpYyA/ICJzbSpcKG1ldGhvZC5zZWxlY3Rvck5hbWUpIiA6ICJtKlwobWV0aG9kLnNlbGVjdG9yTmFtZSkiKQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIl8iLCB3aXRoOiAiIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoIiwgd2l0aDogIl9fIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIpIiwgd2l0aDogIiIpCgogICAgICAgIHZhciBwYXJhbWV0ZXJzTmFtZXMgPSBtZXRob2QucGFyYW1ldGVycy5tYXAgeyAiXCgkMC5uYW1lKSIgfQoKICAgICAgICB3aGlsZSBsZXQgcmFuZ2UgPSByYXdOYW1lLnJhbmdlKG9mOiAiOiIpLCBsZXQgbmFtZSA9IHBhcmFtZXRlcnNOYW1lcy5maXJzdCB7CiAgICAgICAgICAgIHBhcmFtZXRlcnNOYW1lcy5yZW1vdmVGaXJzdCgpCiAgICAgICAgICAgIHJhd05hbWUucmVwbGFjZVN1YnJhbmdlKHJhbmdlLCB3aXRoOiAiX1wobmFtZSkiKQogICAgICAgIH0KCiAgICAgICAgbGV0IHRyaW1TZXQgPSBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiXyIpCgogICAgICAgIHJldHVybiAgcmF3TmFtZQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIjoiLCB3aXRoOiAiIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJtKiIsIHdpdGg6ICJtXyIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiX19fIiwgd2l0aDogIl9fIikudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiB0cmltU2V0KQogICAgfQogICAgcHJpdmF0ZSB2YXIgdW5pcXVlTmFtZTogU3RyaW5nIHsKICAgICAgICB2YXIgcmF3TmFtZSA9IChtZXRob2QuaXNTdGF0aWMgPyAic21fXChtZXRob2Quc2VsZWN0b3JOYW1lKSIgOiAibV9cKG1ldGhvZC5zZWxlY3Rvck5hbWUpIikKICAgICAgICB2YXIgcGFyYW1ldGVyc05hbWVzID0gbWV0aG9kLnBhcmFtZXRlcnMubWFwIHsgIlwoJDAubmFtZSlfb2ZfXCgkMC50eXBlTmFtZS5uYW1lKSIgfQoKICAgICAgICB3aGlsZSBsZXQgcmFuZ2UgPSByYXdOYW1lLnJhbmdlKG9mOiAiOiIpLCBsZXQgbmFtZSA9IHBhcmFtZXRlcnNOYW1lcy5maXJzdCB7CiAgICAgICAgICAgIHBhcmFtZXRlcnNOYW1lcy5yZW1vdmVGaXJzdCgpCiAgICAgICAgICAgIHJhd05hbWUucmVwbGFjZVN1YnJhbmdlKHJhbmdlLCB3aXRoOiAiX1wobmFtZSkiKQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJhd05hbWUudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiXyIpKQogICAgfQogICAgcHJpdmF0ZSB2YXIgdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlOiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlUmF3ID0gIlwobWV0aG9kLnJldHVyblR5cGVOYW1lKSIKICAgICAgICB2YXIgcmV0dXJuVHlwZVN0cmlwcGVkOiBTdHJpbmcgPSB7CiAgICAgICAgICAgIGd1YXJkIGxldCByYW5nZSA9IHJldHVyblR5cGVSYXcucmFuZ2Uob2Y6ICJ3aGVyZSIpIGVsc2UgeyByZXR1cm4gcmV0dXJuVHlwZVJhdyB9CiAgICAgICAgICAgIHZhciBzdHJpcHBlZCA9IHJldHVyblR5cGVSYXcKICAgICAgICAgICAgc3RyaXBwZWQucmVtb3ZlU3VicmFuZ2UoKHJhbmdlLmxvd2VyQm91bmQpLi4uKQogICAgICAgICAgICByZXR1cm4gc3RyaXBwZWQKICAgICAgICB9KCkKICAgICAgICByZXR1cm5UeXBlU3RyaXBwZWQgPSByZXR1cm5UeXBlU3RyaXBwZWQudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiICIpKQogICAgICAgIHJldHVybiAiXCh1bmlxdWVOYW1lKS0+XChyZXR1cm5UeXBlU3RyaXBwZWQpIgogICAgfQogICAgcHJpdmF0ZSB2YXIgbmFtZVN1ZmZpeDogU3RyaW5nIHsKICAgICAgICBndWFyZCBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbcmVnaXN0cmF0aW9uTmFtZV0gZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgY291bnQgPiAxIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIGxldCBpbmRleCA9IE1ldGhvZFdyYXBwZXIuc3VmZml4ZXNbdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlXSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIl9cKGluZGV4KSIKICAgIH0KCiAgICB2YXIgcHJvdG90eXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChyZWdpc3RyYXRpb25OYW1lKVwobmFtZVN1ZmZpeCkiLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiYCIsIHdpdGg6ICIiKQogICAgfQogICAgdmFyIHBhcmFtZXRlcnM6IFtQYXJhbWV0ZXJXcmFwcGVyXSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5wYXJhbWV0ZXJzLm1hcCB7IFBhcmFtZXRlcldyYXBwZXIoJDApIH0KICAgIH0KICAgIHZhciBmdW5jdGlvblByb3RvdHlwZTogU3RyaW5nIHsKICAgICAgICBsZXQgdGhyb3dpbmc6IFN0cmluZyA9IHsKICAgICAgICAgICAgaWYgbWV0aG9kLnRocm93cyB7CiAgICAgICAgICAgICAgICByZXR1cm4gInRocm93cyAiCiAgICAgICAgICAgIH0gZWxzZSBpZiBtZXRob2QucmV0aHJvd3MgewogICAgICAgICAgICAgICAgcmV0dXJuICJyZXRocm93cyAiCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgfQogICAgICAgIH0oKQoKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXI6IFN0cmluZyA9ICJcKGFjY2Vzc01vZGlmaWVyKSAiCiAgICAgICAgbGV0IHBhcmFtcyA9IHJlcGxhY2luZ1NlbGYocGFyYW1ldGVyc0ZvclN0dWJTaWduYXR1cmUoKSkKCiAgICAgICAgaWYgbWV0aG9kLmlzSW5pdGlhbGl6ZXIgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyByZXF1aXJlZCBcKG1ldGhvZC5uYW1lKSBcKHRocm93aW5nKSIKICAgICAgICB9IGVsc2UgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCB7CiAgICAgICAgICAgIGxldCB3aGVyZVBhcnRJZk5lZWRlZDogU3RyaW5nID0gewogICAgICAgICAgICAgICAgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUuaGFzUHJlZml4KCJWb2lkIikgewogICAgICAgICAgICAgICAgICAgIGxldCByYW5nZSA9IG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lLnJhbmdlKG9mOiAiVm9pZCIpIQogICAgICAgICAgICAgICAgICAgIHJldHVybiAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUubmFtZVtyYW5nZS51cHBlckJvdW5kLi4uXSkiCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhbWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUuaXNFbXB0eSA/ICJcKG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lKSAiIDogIiIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSgpCiAgICAgICAgICAgIHJldHVybiAiXChzdGF0aWNNb2RpZmllcilmdW5jIFwobWV0aG9kLnNob3J0TmFtZSlcKHBhcmFtcykgXCh0aHJvd2luZylcKHdoZXJlUGFydElmTmVlZGVkKSIKICAgICAgICB9IGVsc2UgaWYgcmV0dXJuc0dlbmVyaWNDb25zdHJhaW5lZFRvU2VsZiB7CiAgICAgICAgICAgIHJldHVybiAiXChzdGF0aWNNb2RpZmllcilmdW5jIFwobWV0aG9kLnNob3J0TmFtZSlcKHBhcmFtcykgXCh0aHJvd2luZyktPiBcKHJldHVyblR5cGVSZXBsYWNpbmdTZWxmKSAiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJcKHN0YXRpY01vZGlmaWVyKWZ1bmMgXChtZXRob2Quc2hvcnROYW1lKVwocGFyYW1zKSBcKHRocm93aW5nKS0+IFwobWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUpICIKICAgICAgICB9CiAgICB9CiAgICB2YXIgaW52b2NhdGlvbjogU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAiYWRkSW52b2NhdGlvbiguXChwcm90b3R5cGUpKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gImFkZEludm9jYXRpb24oLlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKCkpKSkiCiAgICAgICAgfQogICAgfQogICAgdmFyIGdpdmVuVmFsdWU6IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5pc0luaXRpYWxpemVyIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIG1ldGhvZC50aHJvd3MgfHwgIW1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgZWxzZSB7IHJldHVybiAiIiB9CgogICAgICAgIGxldCBtZXRob2RUeXBlID0gbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSA/ICIuXChwcm90b3R5cGUpIiA6ICIuXChwcm90b3R5cGUpKFwocGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoKSkpIgogICAgICAgIGxldCByZXR1cm5UeXBlOiBTdHJpbmcgPSByZXR1cm5zU2VsZiA/ICJfX1NlbGZfXyIgOiAiXChUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkKSIKCiAgICAgICAgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCB7CiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgXG5cdFx0ZG8gewogICAgICAgICAgICBcdFx0ICAgIF8gPSB0cnkgbWV0aG9kUmV0dXJuVmFsdWUoXChtZXRob2RUeXBlKSkuY2FzdGVkKCkgYXMgVm9pZAogICAgICAgICAgICBcdFx0fVwoIiAiKQogICAgICAgICAgICAiIiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzT3B0aW9uYWwgPyAiID0gbmlsIiA6ICIiCiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgXG5cdFx0dmFyIF9fdmFsdWU6IFwocmV0dXJuVHlwZSlcKGRlZmF1bHRWYWx1ZSkKICAgICAgICAgICAgXHRcdGRvIHsKICAgICAgICAgICAgXHRcdCAgICBfX3ZhbHVlID0gdHJ5IG1ldGhvZFJldHVyblZhbHVlKFwobWV0aG9kVHlwZSkpLmNhc3RlZCgpCiAgICAgICAgICAgIFx0XHR9XCgiICIpCiAgICAgICAgICAgICIiIgogICAgICAgIH0KICAgIH0KICAgIHZhciB0aHJvd1ZhbHVlOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNJbml0aWFsaXplciBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICBndWFyZCBtZXRob2QudGhyb3dzIHx8ICFtZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCBzYWZlRmFpbHVyZSA9IG1ldGhvZC5pc1N0YXRpYyA/ICIiIDogIlx0XHRcdG9uRmF0YWxGYWlsdXJlKFwiXChub1N0dWJEZWZpbmVkTWVzc2FnZSlcIilcbiIKICAgICAgICAvLyBGb3IgVm9pZCBhbmQgUmV0dXJuaW5nIG9wdGlvbmFscyAtIHdlIGFsbG93IG5vdCBzdHViYmVkIGNhc2UgdG8gaGFwcGVuLCBhcyB3ZSBhcmUgc3RpbGwgYWJsZSB0byByZXR1cm4KICAgICAgICBsZXQgbm9TdHViSGFuZGxpbmcgPSBtZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkIHx8IG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc09wdGlvbmFsID8gIlx0XHRcdC8vIGRvIG5vdGhpbmciIDogIlwoc2FmZUZhaWx1cmUpXHRcdFx0RmFpbHVyZShcIlwobm9TdHViRGVmaW5lZE1lc3NhZ2UpXCIpIgogICAgICAgIGd1YXJkIG1ldGhvZC50aHJvd3MgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICBcKG5vU3R1YkhhbmRsaW5nKQogICAgICAgICAgICBcdFx0fQogICAgICAgICAgICAiIiIKICAgICAgICB9CgogICAgICAgIHJldHVybiAiIiIKICAgICAgICBjYXRjaCBNb2NrRXJyb3Iubm90U3R1YmVkIHsKICAgICAgICBcKG5vU3R1YkhhbmRsaW5nKQogICAgICAgIFx0XHR9IGNhdGNoIHsKICAgICAgICBcdFx0ICAgIHRocm93IGVycm9yCiAgICAgICAgXHRcdH0KICAgICAgICAiIiIKICAgIH0KICAgIHZhciByZXR1cm5WYWx1ZTogU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgZWxzZSB7IHJldHVybiAiIiB9CgogICAgICAgIHJldHVybiAiXG5cdFx0cmV0dXJuIF9fdmFsdWUiCiAgICB9CiAgICB2YXIgZXF1YWxDYXNlOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNJbml0aWFsaXplciBlbHNlIHsgcmV0dXJuICIiIH0KCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAiY2FzZSAoLlwocHJvdG90eXBlKSwgLlwocHJvdG90eXBlKSk6IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBsaHNQYXJhbXMgPSBtZXRob2QucGFyYW1ldGVycy5tYXAgeyAibGV0IGxoc1woJDAubmFtZS5jYXBpdGFsaXplZCkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICAgICAgbGV0IHJoc1BhcmFtcyA9IG1ldGhvZC5wYXJhbWV0ZXJzLm1hcCB7ICJsZXQgcmhzXCgkMC5uYW1lLmNhcGl0YWxpemVkKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgICAgICByZXR1cm4gImNhc2UgKC5cKHByb3RvdHlwZSkoXChsaHNQYXJhbXMpKSwgLlwocHJvdG90eXBlKShcKHJoc1BhcmFtcykpKToiCiAgICAgICAgfQogICAgfQogICAgdmFyIGludFZhbHVlQ2FzZTogU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJjYXNlIC5cKHByb3RvdHlwZSk6IHJldHVybiAwIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBwYXJhbXMgPSBtZXRob2QucGFyYW1ldGVycy5lbnVtZXJhdGVkKCkubWFwIHsgb2Zmc2V0LCBfIGluCiAgICAgICAgICAgICAgICByZXR1cm4gInBcKG9mZnNldCkiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGRlZmluaXRpb25zID0gcGFyYW1zLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgICAgIGxldCBwYXJhbXNTdW0gPSBwYXJhbXMubWFwKHsgIlwoJDApLmludFZhbHVlIiB9KS5qb2luZWQoc2VwYXJhdG9yOiAiICsgIikKICAgICAgICAgICAgcmV0dXJuICJjYXNlIGxldCAuXChwcm90b3R5cGUpKFwoZGVmaW5pdGlvbnMpKTogcmV0dXJuIFwocGFyYW1zU3VtKSIKICAgICAgICB9CiAgICB9CgogICAgdmFyIHJldHVybnNTZWxmOiBCb29sIHsKICAgICAgICBndWFyZCAhcmV0dXJuc0dlbmVyaWNDb25zdHJhaW5lZFRvU2VsZiBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIHJldHVybiAhbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCAmJiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLmlzU2VsZlR5cGUKICAgIH0KICAgIHZhciByZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmOiBCb29sIHsKICAgICAgICBsZXQgZGVmYXVsdFJldHVyblR5cGUgPSAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUubmFtZSkgIgogICAgICAgIHJldHVybiBkZWZhdWx0UmV0dXJuVHlwZSAhPSByZXR1cm5UeXBlUmVwbGFjaW5nU2VsZgogICAgfQogICAgdmFyIHJldHVyblR5cGVSZXBsYWNpbmdTZWxmOiBTdHJpbmcgewogICAgICAgIHJldHVybiByZXBsYWNpbmdTZWxmKCJcKG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lKSAiKQogICAgfQogICAgdmFyIHBhcmFtZXRlcnNDb250YWluc1NlbGY6IEJvb2wgewogICAgICAgIHJldHVybiByZXBsYWNpbmdTZWxmKHBhcmFtZXRlcnNGb3JTdHViU2lnbmF0dXJlKCkpICE9IHBhcmFtZXRlcnNGb3JTdHViU2lnbmF0dXJlKCkKICAgIH0KCiAgICB2YXIgcmVwbGFjZVNlbGY6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIEN1cnJlbnQuc2VsZlR5cGUKICAgIH0KCiAgICBpbml0KF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kKSB7CiAgICAgICAgc2VsZi5tZXRob2QgPSBtZXRob2QKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGZ1bmMgY2xlYXIoKSAtPiBTdHJpbmcgewogICAgICAgIE1ldGhvZFdyYXBwZXIucmVnaXN0ZXJlZCA9IFs6XQogICAgICAgIE1ldGhvZFdyYXBwZXIuc3VmZml4ZXMgPSBbOl0KICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGUgPSBbOl0KICAgICAgICByZXR1cm4gIiIKICAgIH0KCiAgICBmdW5jIHJlZ2lzdGVyKCkgewogICAgICAgIE1ldGhvZFdyYXBwZXIucmVnaXN0ZXIocmVnaXN0cmF0aW9uTmFtZSx1bmlxdWVOYW1lLHVuaXF1ZU5hbWVXaXRoUmV0dXJuVHlwZSkKICAgIH0KCiAgICBzdGF0aWMgZnVuYyByZWdpc3RlcihfIG5hbWU6IFN0cmluZywgXyB1bmlxdWVOYW1lOiBTdHJpbmcsIF8gdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlOiBTdHJpbmcpIHsKICAgICAgICBpZiBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gPSBjb3VudCArIDEKICAgICAgICAgICAgTWV0aG9kV3JhcHBlci5zdWZmaXhlc1t1bmlxdWVOYW1lV2l0aFJldHVyblR5cGVdID0gY291bnQgKyAxCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgTWV0aG9kV3JhcHBlci5yZWdpc3RlcmVkW25hbWVdID0gMQogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzW3VuaXF1ZU5hbWVXaXRoUmV0dXJuVHlwZV0gPSAxCiAgICAgICAgfQoKICAgICAgICBpZiBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPSBjb3VudCArIDEKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPSAxCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgcmV0dXJuVHlwZU1hdHRlcnMoKSAtPiBCb29sIHsKICAgICAgICBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPz8gMAogICAgICAgIHJldHVybiBjb3VudCA+IDEKICAgIH0KCiAgICBmdW5jIHdyYXBwZWRJbk1ldGhvZFR5cGUoKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gIW1ldGhvZC5pc0luaXRpYWxpemVyCiAgICB9CgogICAgZnVuYyByZXR1cm5pbmdQYXJhbWV0ZXIoXyBtdWx0aXBsZTogQm9vbCwgXyBmcm9udDogQm9vbCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCByZXR1cm5UeXBlTWF0dGVycygpIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCByZXR1cm5pbmc6IFN0cmluZyA9ICJyZXR1cm5pbmc6IFwocmV0dXJuVHlwZVN0cmlwcGVkKG1ldGhvZCwgdHlwZTogdHJ1ZSkpIgogICAgICAgIGd1YXJkIG11bHRpcGxlIGVsc2UgeyByZXR1cm4gcmV0dXJuaW5nIH0KCiAgICAgICAgcmV0dXJuIGZyb250ID8gIiwgXChyZXR1cm5pbmcpIiA6ICJcKHJldHVybmluZyksICIKICAgIH0KCiAgICAvLyBTdHViCiAgICBmdW5jIHN0dWJCb2R5KCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgYm9keTogU3RyaW5nID0gewogICAgICAgICAgICBpZiBtZXRob2QuaXNJbml0aWFsaXplciB8fCAhcmV0dXJuc1NlbGYgewogICAgICAgICAgICAgICAgcmV0dXJuIGludm9jYXRpb24gKyBwZXJmb3JtQ2FsbCgpICsgZ2l2ZW5WYWx1ZSArIHRocm93VmFsdWUgKyByZXR1cm5WYWx1ZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHdyYXBwZWRTdHViUHJlZml4KCkKICAgICAgICAgICAgICAgICAgICArICJcdFx0IiArIGludm9jYXRpb24KICAgICAgICAgICAgICAgICAgICArIHBlcmZvcm1DYWxsKCkKICAgICAgICAgICAgICAgICAgICArIGdpdmVuVmFsdWUKICAgICAgICAgICAgICAgICAgICArIHRocm93VmFsdWUKICAgICAgICAgICAgICAgICAgICArIHJldHVyblZhbHVlCiAgICAgICAgICAgICAgICAgICAgKyB3cmFwcGVkU3R1YlBvc3RmaXgoKQogICAgICAgICAgICB9CiAgICAgICAgfSgpCiAgICAgICAgcmV0dXJuIHJlcGxhY2luZ1NlbGYoYm9keSkKICAgIH0KCiAgICBmdW5jIHdyYXBwZWRTdHViUHJlZml4KCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIsIHJldHVybnNTZWxmIGVsc2UgewogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICB9CgogICAgICAgIGxldCB0aHJvd2luZzogU3RyaW5nID0gewogICAgICAgICAgICBpZiBtZXRob2QudGhyb3dzIHsKICAgICAgICAgICAgICAgIHJldHVybiAidGhyb3dzICIKICAgICAgICAgICAgfSBlbHNlIGlmIG1ldGhvZC5yZXRocm93cyB7CiAgICAgICAgICAgICAgICByZXR1cm4gInJldGhyb3dzICIKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgICAgICB9CiAgICAgICAgfSgpCgogICAgICAgIHJldHVybiAiZnVuYyBfd3JhcHBlZDxfX1NlbGZfXz4oKSBcKHRocm93aW5nKS0+IF9fU2VsZl9fIHtcbiIKICAgIH0KCiAgICBmdW5jIHdyYXBwZWRTdHViUG9zdGZpeCgpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5pc0luaXRpYWxpemVyLCByZXR1cm5zU2VsZiBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgfQoKICAgICAgICBsZXQgdGhyb3dpbmc6IFN0cmluZyA9IChtZXRob2QudGhyb3dzIHx8IG1ldGhvZC5yZXRocm93cykgPyAidHJ5ICI6ICIiCgogICAgICAgIHJldHVybiAiXG5cdFx0fSIKICAgICAgICAgICAgKyAiXG5cdFx0cmV0dXJuIFwodGhyb3dpbmcpX3dyYXBwZWQoKSIKICAgIH0KCiAgICAvLyBNZXRob2QgVHlwZQogICAgZnVuYyBtZXRob2RUeXBlRGVjbGFyYXRpb25XaXRoUGFyYW1ldGVycygpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgZWxzZSB7IHJldHVybiAiXChwcm90b3R5cGUpIiB9CiAgICAgICAgcmV0dXJuICJcKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yTWV0aG9kVHlwZURlY2xhcmF0aW9uKCkpKSIKICAgIH0KCiAgICAvLyBHaXZlbgogICAgZnVuYyBjb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5jb250YWlucyh3aGVyZTogeyAkMC5wYXJhbWV0ZXIuYXJndW1lbnRMYWJlbCA9PSBuaWwgfSkKICAgIH0KCiAgICBmdW5jIGdpdmVuUmV0dXJuVHlwZVN0cmluZygpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVTdHJpbmc6IFN0cmluZyA9IHsKICAgICAgICAgICAgZ3VhcmQgIXJldHVybnNHZW5lcmljQ29uc3RyYWluZWRUb1NlbGYgZWxzZSB7IHJldHVybiByZXR1cm5UeXBlUmVwbGFjaW5nU2VsZiB9CiAgICAgICAgICAgIGd1YXJkICFyZXR1cm5zU2VsZiBlbHNlIHsgcmV0dXJuIHJlcGxhY2VTZWxmIH0KICAgICAgICAgICAgcmV0dXJuIFR5cGVXcmFwcGVyKG1ldGhvZC5yZXR1cm5UeXBlTmFtZSkuc3RyaXBwZWQKICAgICAgICB9KCkKICAgICAgICByZXR1cm4gcmV0dXJuVHlwZVN0cmluZwogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUocHJlZml4OiBTdHJpbmcgPSAiIiwgZGVwcmVjYXRlZDogQm9vbCA9IGZhbHNlLCBhbm5vdGF0ZWQ6IEJvb2wgPSB0cnVlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBhbm5vdGF0aW9uID0gYW5ub3RhdGVkICYmIGRlcHJlY2F0ZWQgPyBkZXByZWNhdGVkTWVzc2FnZShkZXByZWNhdGVkUGFyYW1ldGVyc01lc3NhZ2UoKSkgOiAiIgogICAgICAgIGxldCByZXR1cm5UeXBlU3RyaW5nID0gZ2l2ZW5SZXR1cm5UeXBlU3RyaW5nKCkKCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkod2lsbFJldHVybjogXChyZXR1cm5UeXBlU3RyaW5nKS4uLikgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwoYW5ub3RhdGlvbilwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKShcKHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZShkZXByZWNhdGVkOiBkZXByZWNhdGVkKSksIHdpbGxSZXR1cm46IFwocmV0dXJuVHlwZVN0cmluZykuLi4pIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3Rvck5hbWVUaHJvd3MocHJlZml4OiBTdHJpbmcgPSAiIiwgZGVwcmVjYXRlZDogQm9vbCA9IGZhbHNlLCBhbm5vdGF0ZWQ6IEJvb2wgPSB0cnVlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBhbm5vdGF0aW9uID0gYW5ub3RhdGVkICYmIGRlcHJlY2F0ZWQgPyBkZXByZWNhdGVkTWVzc2FnZShkZXByZWNhdGVkUGFyYW1ldGVyc01lc3NhZ2UoKSkgOiAiIgogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKHdpbGxUaHJvdzogRXJyb3IuLi4pIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJcKGFubm90YXRpb24pcHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoZGVwcmVjYXRlZDogZGVwcmVjYXRlZCkpLCB3aWxsVGhyb3c6IEVycm9yLi4uKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3IocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpR2l2ZW4obWV0aG9kOiAuXChwcm90b3R5cGUpLCBwcm9kdWN0czogd2lsbFJldHVybi5tYXAoeyBTdHViUHJvZHVjdC5yZXR1cm4oJDAgYXMgQW55KSB9KSkiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpR2l2ZW4obWV0aG9kOiAuXChwcm90b3R5cGUpKFwocGFyYW1ldGVyc0ZvclByb3h5SW5pdCgpKSksIHByb2R1Y3RzOiB3aWxsUmV0dXJuLm1hcCh7IFN0dWJQcm9kdWN0LnJldHVybigkMCBhcyBBbnkpIH0pKSIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBnaXZlbkNvbnN0cnVjdG9yVGhyb3dzKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KUdpdmVuKG1ldGhvZDogLlwocHJvdG90eXBlKSwgcHJvZHVjdHM6IHdpbGxUaHJvdy5tYXAoeyBTdHViUHJvZHVjdC50aHJvdygkMCkgfSkpIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KUdpdmVuKG1ldGhvZDogLlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JQcm94eUluaXQoKSkpLCBwcm9kdWN0czogd2lsbFRocm93Lm1hcCh7IFN0dWJQcm9kdWN0LnRocm93KCQwKSB9KSkiCiAgICAgICAgfQogICAgfQoKICAgIC8vIEdpdmVuIHdpbGxQcm9kdWNlCiAgICBmdW5jIGdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlU3RyaW5nID0gZ2l2ZW5SZXR1cm5UeXBlU3RyaW5nKCkKICAgICAgICBsZXQgcHJvZHVjZUNsb3N1cmUgPSAiKFN0dWJiZXI8XChyZXR1cm5UeXBlU3RyaW5nKT4pIC0+IFZvaWQiCgogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKHdpbGxQcm9kdWNlOiBcKHByb2R1Y2VDbG9zdXJlKSkgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKCkpLCB3aWxsUHJvZHVjZTogXChwcm9kdWNlQ2xvc3VyZSkpIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JOYW1lVGhyb3dzKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVTdHJpbmcgPSBnaXZlblJldHVyblR5cGVTdHJpbmcoKQogICAgICAgIGxldCBwcm9kdWNlQ2xvc3VyZSA9ICIoU3R1YmJlclRocm93czxcKHJldHVyblR5cGVTdHJpbmcpPikgLT4gVm9pZCIKCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkod2lsbFByb2R1Y2U6IFwocHJvZHVjZUNsb3N1cmUpKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoKSksIHdpbGxQcm9kdWNlOiBcKHByb2R1Y2VDbG9zdXJlKSkgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBnaXZlblByb2R1Y2VDb25zdHJ1Y3RvcihwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlU3RyaW5nID0gZ2l2ZW5SZXR1cm5UeXBlU3RyaW5nKCkKICAgICAgICByZXR1cm4gIiIiCiAgICAgICAgbGV0IHdpbGxSZXR1cm46IFtcKHJldHVyblR5cGVTdHJpbmcpXSA9IFtdCiAgICAgICAgXHRcdFx0bGV0IGdpdmVuOiBcKHByZWZpeClHaXZlbiA9IHsgXChnaXZlbkNvbnN0cnVjdG9yKHByZWZpeDogcHJlZml4KSkgfSgpCiAgICAgICAgXHRcdFx0bGV0IHN0dWJiZXIgPSBnaXZlbi5zdHViKGZvcjogKFwocmV0dXJuVHlwZVN0cmluZykpLnNlbGYpCiAgICAgICAgXHRcdFx0d2lsbFByb2R1Y2Uoc3R1YmJlcikKICAgICAgICBcdFx0XHRyZXR1cm4gZ2l2ZW4KICAgICAgICAiIiIKICAgIH0KCiAgICBmdW5jIGdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yVGhyb3dzKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVTdHJpbmcgPSBnaXZlblJldHVyblR5cGVTdHJpbmcoKQogICAgICAgIHJldHVybiAiIiIKICAgICAgICBsZXQgd2lsbFRocm93OiBbRXJyb3JdID0gW10KICAgICAgICBcdFx0XHRsZXQgZ2l2ZW46IFwocHJlZml4KUdpdmVuID0geyBcKGdpdmVuQ29uc3RydWN0b3JUaHJvd3MocHJlZml4OiBwcmVmaXgpKSB9KCkKICAgICAgICBcdFx0XHRsZXQgc3R1YmJlciA9IGdpdmVuLnN0dWJUaHJvd3MoZm9yOiAoXChyZXR1cm5UeXBlU3RyaW5nKSkuc2VsZikKICAgICAgICBcdFx0XHR3aWxsUHJvZHVjZShzdHViYmVyKQogICAgICAgIFx0XHRcdHJldHVybiBnaXZlbgogICAgICAgICIiIgogICAgfQoKICAgIC8vIFZlcmlmeQogICAgZnVuYyB2ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6IFN0cmluZyA9ICIiLCBkZXByZWNhdGVkOiBCb29sID0gZmFsc2UsIGFubm90YXRlZDogQm9vbCA9IHRydWUpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IChhbm5vdGF0aW9uLCBtZXRob2ROYW1lLCBnZW5lcmljQ29uc3RyYWlucykgPSBtZXRob2RJbmZvKGRlcHJlY2F0ZWQsIGFubm90YXRlZCkKCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kTmFtZSkoXChyZXR1cm5pbmdQYXJhbWV0ZXIoZmFsc2UsdHJ1ZSkpKSAtPiBcKHByZWZpeClWZXJpZnlcKGdlbmVyaWNDb25zdHJhaW5zKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwoYW5ub3RhdGlvbilwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2ROYW1lKShcKHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZShkZXByZWNhdGVkOiBkZXByZWNhdGVkKSlcKHJldHVybmluZ1BhcmFtZXRlcih0cnVlLHRydWUpKSkgLT4gXChwcmVmaXgpVmVyaWZ5XChnZW5lcmljQ29uc3RyYWlucykiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgdmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3RvcihwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClWZXJpZnkobWV0aG9kOiAuXChwcm90b3R5cGUpKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClWZXJpZnkobWV0aG9kOiAuXChwcm90b3R5cGUpKFwocGFyYW1ldGVyc0ZvclByb3h5SW5pdCgpKSkpIgogICAgICAgIH0KICAgIH0KCiAgICAvLyBQZXJmb3JtCiAgICBmdW5jIHBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6IFN0cmluZyA9ICIiLCBkZXByZWNhdGVkOiBCb29sID0gZmFsc2UsIGFubm90YXRlZDogQm9vbCA9IHRydWUpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGJvZHk6IFN0cmluZyA9IHsKICAgICAgICAgICAgbGV0IChhbm5vdGF0aW9uLCBtZXRob2ROYW1lLCBnZW5lcmljQ29uc3RyYWlucykgPSBtZXRob2RJbmZvKGRlcHJlY2F0ZWQsIGFubm90YXRlZCkKCiAgICAgICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2ROYW1lKShcKHJldHVybmluZ1BhcmFtZXRlcih0cnVlLGZhbHNlKSlwZXJmb3JtOiBAZXNjYXBpbmcgXChwZXJmb3JtUHJveHlDbG9zdXJlVHlwZSgpKSkgLT4gXChwcmVmaXgpUGVyZm9ybVwoZ2VuZXJpY0NvbnN0cmFpbnMpIgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICJcKGFubm90YXRpb24pcHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kTmFtZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoZGVwcmVjYXRlZDogZGVwcmVjYXRlZCkpLCBcKHJldHVybmluZ1BhcmFtZXRlcih0cnVlLGZhbHNlKSlwZXJmb3JtOiBAZXNjYXBpbmcgXChwZXJmb3JtUHJveHlDbG9zdXJlVHlwZSgpKSkgLT4gXChwcmVmaXgpUGVyZm9ybVwoZ2VuZXJpY0NvbnN0cmFpbnMpIgogICAgICAgICAgICB9CiAgICAgICAgfSgpCiAgICAgICAgcmV0dXJuIHJlcGxhY2luZ1NlbGYoYm9keSkKICAgIH0KCiAgICBmdW5jIHBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KVBlcmZvcm0obWV0aG9kOiAuXChwcm90b3R5cGUpLCBwZXJmb3JtczogcGVyZm9ybSkiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpUGVyZm9ybShtZXRob2Q6IC5cKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlJbml0KCkpKSwgcGVyZm9ybXM6IHBlcmZvcm0pIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHBlcmZvcm1Qcm94eUNsb3N1cmVUeXBlKCkgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICIoKSAtPiBWb2lkIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBwYXJhbWV0ZXJzID0gc2VsZi5wYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICAubWFwIHsgIlwoJDAuanVzdFBlcmZvcm1UeXBlKSIgfQogICAgICAgICAgICAgICAgLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgICAgIHJldHVybiAiKFwocGFyYW1ldGVycykpIC0+IFZvaWQiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgcGVyZm9ybVByb3h5Q2xvc3VyZUNhbGwoKSAtPiBTdHJpbmcgewogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInBlcmZvcm0/KCkiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IHBhcmFtZXRlcnMgPSBtZXRob2QucGFyYW1ldGVycwogICAgICAgICAgICAgICAgLm1hcCB7IHAgaW4KICAgICAgICAgICAgICAgICAgICBsZXQgd3JhcHBlZCA9IFBhcmFtZXRlcldyYXBwZXIocCkKICAgICAgICAgICAgICAgICAgICBsZXQgaXNBdXRvbG9zdXJlID0gd3JhcHBlZC5qdXN0VHlwZS5oYXNQcmVmaXgoIkBhdXRvY2xvc3VyZSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJcKHAuaW5vdXQgPyAiJiIgOiAiIilgXChwLm5hbWUpYFwoaXNBdXRvbG9zdXJlID8gIigpIiA6ICIiKSIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgICAgICByZXR1cm4gInBlcmZvcm0/KFwocGFyYW1ldGVycykpIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHBlcmZvcm1DYWxsKCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgbGV0IHR5cGUgPSBwZXJmb3JtUHJveHlDbG9zdXJlVHlwZSgpCiAgICAgICAgdmFyIHByb3h5ID0gbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSA/ICJcKHByb3RvdHlwZSkiIDogIlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKCkpKSIKCiAgICAgICAgbGV0IGNhc3QgPSAibGV0IHBlcmZvcm0gPSBtZXRob2RQZXJmb3JtVmFsdWUoLlwocHJveHkpKSBhcz8gXCh0eXBlKSIKICAgICAgICBsZXQgY2FsbCA9IHBlcmZvcm1Qcm94eUNsb3N1cmVDYWxsKCkKCiAgICAgICAgcmV0dXJuICJcblx0XHRcKGNhc3QpXG5cdFx0XChjYWxsKSIKICAgIH0KCiAgICAvLyBIZWxwZXJzCiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZW5lcmljcyA9IGdldEdlbmVyaWNzV2l0aG91dENvbnN0cmFpbnRzKCkKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5tYXAgeyAkMC53cmFwcGVkRm9yQ2FsbHMoZ2VuZXJpY3MpIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0Zvck1ldGhvZFR5cGVEZWNsYXJhdGlvbigpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGdlbmVyaWNzID0gZ2V0R2VuZXJpY3NXaXRob3V0Q29uc3RyYWludHMoKQogICAgICAgIHJldHVybiBwYXJhbWV0ZXJzLm1hcCB7IHBhcmFtIGluCiAgICAgICAgICAgIHJldHVybiBwYXJhbS5pc0dlbmVyaWMoZ2VuZXJpY3MpID8gcGFyYW0uZ2VuZXJpY1R5cGUgOiByZXBsYWNpbmdTZWxmKHBhcmFtLm5lc3RlZFR5cGUpCiAgICAgICAgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgfQoKICAgIHByaXZhdGUgZnVuYyBwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoZGVwcmVjYXRlZDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiBwYXJhbWV0ZXJzLm1hcCB7IHAgaW4KICAgICAgICAgICAgZ3VhcmQgZGVwcmVjYXRlZCBlbHNlIHsgcmV0dXJuICJcKHAubGFiZWxBbmROYW1lKCkpOiBcKHJlcGxhY2luZ1NlbGYocC5uZXN0ZWRUeXBlKSkiIH0KICAgICAgICAgICAgZ3VhcmQgbGV0IGFyZ3VtZW50TGFiZWwgPSBwLnBhcmFtZXRlci5hcmd1bWVudExhYmVsIGVsc2UgeyByZXR1cm4gIlwocC5wYXJhbWV0ZXIubmFtZSk6IFwocmVwbGFjaW5nU2VsZihwLm5lc3RlZFR5cGUpKSIgfQogICAgICAgICAgICBndWFyZCBhcmd1bWVudExhYmVsICE9IHAubmFtZSBlbHNlIHsgcmV0dXJuICJcKHAucGFyYW1ldGVyLm5hbWUpOiBcKHJlcGxhY2luZ1NlbGYocC5uZXN0ZWRUeXBlKSkiIH0KICAgICAgICAgICAgcmV0dXJuICJcKGFyZ3VtZW50TGFiZWwpIFwocC5wYXJhbWV0ZXIubmFtZSk6IFwocmVwbGFjaW5nU2VsZihwLm5lc3RlZFR5cGUpKSIKICAgICAgICB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIGRlcHJlY2F0ZWRQYXJhbWV0ZXJzTWVzc2FnZSgpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IG5ld1BhcmFtcyA9IHBhcmFtZXRlcnMubWFwIHsgcCBpbiByZXR1cm4gIlwocC5wYXJhbWV0ZXIuYXJndW1lbnRMYWJlbCA/PyAiXyIpIiB9CiAgICAgICAgbGV0IG9sZFBhcmFtcyA9IHBhcmFtZXRlcnMubWFwIHsgcCAtPiBTdHJpbmcgaW4KICAgICAgICAgICAgZ3VhcmQgbGV0IGFyZ3VtZW50TGFiZWwgPSBwLnBhcmFtZXRlci5hcmd1bWVudExhYmVsIGVsc2UgeyByZXR1cm4gIlwocC5wYXJhbWV0ZXIubmFtZSkiIH0KICAgICAgICAgICAgZ3VhcmQgYXJndW1lbnRMYWJlbCAhPSBwLm5hbWUgZWxzZSB7IHJldHVybiAiXChwLnBhcmFtZXRlci5uYW1lKSIgfQogICAgICAgICAgICByZXR1cm4gIlwoYXJndW1lbnRMYWJlbCkiCiAgICAgICAgfQoKICAgICAgICB2YXIgbWVzc2FnZXM6IFtTdHJpbmddID0gW10KICAgICAgICBmb3IgaSBpbiAwLi48bmV3UGFyYW1zLmNvdW50IHsKICAgICAgICAgICAgaWYgbmV3UGFyYW1zW2ldICE9IG9sZFBhcmFtc1tpXSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlcy5hcHBlbmQoIiByZW1vdmUgYFwob2xkUGFyYW1zW2ldKWAgbGFiZWwiKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gIiBQb3NzaWJsZSBmaXg6ICIgKyBtZXNzYWdlcy5qb2luZWQoc2VwYXJhdG9yOiAiLCIpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JTdHViU2lnbmF0dXJlKCkgLT4gU3RyaW5nIHsKICAgICAgICBmdW5jIHJlcGxhY2luZyhmaXJzdDogU3RyaW5nLCBpbiBmdWxsOiBTdHJpbmcsIHdpdGggb3RoZXI6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICAgICAgZ3VhcmQgbGV0IHJhbmdlID0gZnVsbC5yYW5nZShvZjogZmlyc3QpIGVsc2UgeyByZXR1cm4gZnVsbCB9CiAgICAgICAgICAgIHJldHVybiBmdWxsLnJlcGxhY2luZ0NoYXJhY3RlcnMoaW46IHJhbmdlLCB3aXRoOiBvdGhlcikKICAgICAgICB9CiAgICAgICAgbGV0IHByZWZpeCA9IG1ldGhvZC5zaG9ydE5hbWUKICAgICAgICBsZXQgZnVsbCA9IG1ldGhvZC5uYW1lCiAgICAgICAgbGV0IHJhbmdlID0gZnVsbC5yYW5nZShvZjogcHJlZml4KSEKICAgICAgICB2YXIgdW5yZWZpbmVkID0gIlwoZnVsbFtyYW5nZS51cHBlckJvdW5kLi4uXSkiCiAgICAgICAgcGFyYW1ldGVycy5tYXAgeyBwIC0+IChTdHJpbmcsU3RyaW5nKSBpbgogICAgICAgICAgICByZXR1cm4gKCJcKHAudHlwZSkiLCJcKHAuanVzdFR5cGUpIikKICAgICAgICB9LmZvckVhY2ggewogICAgICAgICAgICB1bnJlZmluZWQgPSByZXBsYWNpbmcoZmlyc3Q6ICQwLCBpbjogdW5yZWZpbmVkLCB3aXRoOiAkMSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVucmVmaW5lZAogICAgfQoKICAgIHByaXZhdGUgZnVuYyBwYXJhbWV0ZXJzRm9yUHJveHlJbml0KCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgZ2VuZXJpY3MgPSBnZXRHZW5lcmljc1dpdGhvdXRDb25zdHJhaW50cygpCiAgICAgICAgcmV0dXJuIHBhcmFtZXRlcnMubWFwIHsgIlwoJDAud3JhcHBlZEZvclByb3h5KGdlbmVyaWNzKSkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgaXNHZW5lcmljKCkgLT4gQm9vbCB7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5zaG9ydE5hbWUuY29udGFpbnMoIjwiKSAmJiBtZXRob2Quc2hvcnROYW1lLmNvbnRhaW5zKCI+IikKICAgIH0KCiAgICAvLy8gUmV0dXJucyBsaXN0IG9mIGdlbmVyaWNzIHVzZWQgaW4gbWV0aG9kIHNpZ25hdHVyZSwgd2l0aG91dCB0aGVpciBjb25zdHJhaW50cyAobGlrZSBbVCxVLFZdKQogICAgLy8vCiAgICAvLy8gLSBSZXR1cm5zOiBBcnJheSBvZiBzdHJpbmdzLCB3aGVyZSBlYWNoIHN0cmluZ3MgcmVwcmVzZW50IGdlbmVyaWMgbmFtZQogICAgcHJpdmF0ZSBmdW5jIGdldEdlbmVyaWNzV2l0aG91dENvbnN0cmFpbnRzKCkgLT4gW1N0cmluZ10gewogICAgICAgIGxldCBuYW1lID0gbWV0aG9kLnNob3J0TmFtZQogICAgICAgIGd1YXJkIGxldCBzdGFydCA9IG5hbWUuaW5kZXgob2Y6ICI8IiksIGxldCBlbmQgPSBuYW1lLmluZGV4KG9mOiAiPiIpIGVsc2UgeyByZXR1cm4gW10gfQoKICAgICAgICB2YXIgZ2VuUGFydCA9IG5hbWVbc3RhcnQuLi5lbmRdCiAgICAgICAgZ2VuUGFydC5yZW1vdmVGaXJzdCgpCiAgICAgICAgZ2VuUGFydC5yZW1vdmVMYXN0KCkKCiAgICAgICAgbGV0IHBhcnRzID0gZ2VuUGFydC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiAiLCB3aXRoOiAiIikuY2hhcmFjdGVycy5zcGxpdChzZXBhcmF0b3I6ICIsIikubWFwKFN0cmluZy5pbml0KQogICAgICAgIHJldHVybiBwYXJ0cy5tYXAgeyBzdHJpcEdlblBhcnQocGFydDogJDApIH0KICAgIH0KCiAgICAvLy8gUmV0dXJucyBsaXN0IG9mIGdlbmVyaWMgY29uc3RyYWludGVzIGZyb20gbWV0aG9kIHNpZ25hdHVyZS4gRG9lcyBvbmx5IGNvbnRhaW4gc3R1ZmYgYmV0d2VlbiAnPCcgYW5kICc+JwogICAgLy8vCiAgICAvLy8gLSBSZXR1cm5zOiBBcnJheSBvZiBzdHJpbmdzLCBsaWtlIFsiVDogQ29kYWJsZSIsICJVOiBXaGF0ZXZlciJdCiAgICBwcml2YXRlIGZ1bmMgZ2V0R2VuZXJpY3NDb25zdHJhaW50cyhfIGdlbmVyaWNzOiBbU3RyaW5nXSkgLT4gW1N0cmluZ10gewogICAgICAgIGxldCBuYW1lID0gbWV0aG9kLnNob3J0TmFtZQogICAgICAgIGd1YXJkIGxldCBzdGFydCA9IG5hbWUuaW5kZXgob2Y6ICI8IiksIGxldCBlbmQgPSBuYW1lLmluZGV4KG9mOiAiPiIpIGVsc2UgeyByZXR1cm4gW10gfQoKICAgICAgICB2YXIgZ2VuUGFydCA9IG5hbWVbc3RhcnQuLi5lbmRdCiAgICAgICAgZ2VuUGFydC5yZW1vdmVGaXJzdCgpCiAgICAgICAgZ2VuUGFydC5yZW1vdmVMYXN0KCkKCiAgICAgICAgbGV0IHBhcnRzID0gZ2VuUGFydC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiAiLCB3aXRoOiAiIikuY2hhcmFjdGVycy5zcGxpdChzZXBhcmF0b3I6ICIsIikubWFwKFN0cmluZy5pbml0KQogICAgICAgIHJldHVybiBwYXJ0cy5maWx0ZXIgewogICAgICAgICAgICBsZXQgY29tcG9uZW50cyA9ICQwLmNvbXBvbmVudHMoc2VwYXJhdGVkQnk6ICI6IikKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudHMuY291bnQgPT0gMiAmJiBnZW5lcmljcy5jb250YWlucyhjb21wb25lbnRzWzBdKQogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgZ2V0R2VuZXJpY3NBbW9uZ1BhcmFtZXRlcnMoKSAtPiBbU3RyaW5nXSB7CiAgICAgICAgcmV0dXJuIGdldEdlbmVyaWNzV2l0aG91dENvbnN0cmFpbnRzKCkuZmlsdGVyIHsKICAgICAgICAgICAgZm9yIHBhcmFtIGluIHNlbGYucGFyYW1ldGVycyB7CiAgICAgICAgICAgICAgICBpZiBwYXJhbS5pc0dlbmVyaWMoWyQwXSkgeyByZXR1cm4gdHJ1ZSB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgfQoKICAgIHByaXZhdGUgZnVuYyB3cmFwR2VuZXJpY3MoXyBnZW5lcmljczogW1N0cmluZ10pIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIWdlbmVyaWNzLmlzRW1wdHkgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgcmV0dXJuICI8XChnZW5lcmljcy5qb2luZWQoc2VwYXJhdG9yOiIsIikpPiIKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgc3RyaXBHZW5QYXJ0KHBhcnQ6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gcGFydC5jaGFyYWN0ZXJzLnNwbGl0KHNlcGFyYXRvcjogIjoiKS5tYXAoU3RyaW5nLmluaXQpLmZpcnN0IQogICAgfQoKICAgIHByaXZhdGUgZnVuYyByZXR1cm5UeXBlU3RyaXBwZWQoXyBtZXRob2Q6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QsIHR5cGU6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVJhdyA9ICJcKG1ldGhvZC5yZXR1cm5UeXBlTmFtZSkiCiAgICAgICAgdmFyIHN0cmlwcGVkOiBTdHJpbmcgPSB7CiAgICAgICAgICAgIGd1YXJkIGxldCByYW5nZSA9IHJldHVyblR5cGVSYXcucmFuZ2Uob2Y6ICJ3aGVyZSIpIGVsc2UgeyByZXR1cm4gcmV0dXJuVHlwZVJhdyB9CiAgICAgICAgICAgIHZhciBzdHJpcHBlZCA9IHJldHVyblR5cGVSYXcKICAgICAgICAgICAgc3RyaXBwZWQucmVtb3ZlU3VicmFuZ2UoKHJhbmdlLmxvd2VyQm91bmQpLi4uKQogICAgICAgICAgICByZXR1cm4gc3RyaXBwZWQKICAgICAgICB9KCkKICAgICAgICBzdHJpcHBlZCA9IHN0cmlwcGVkLnRyaW1taW5nQ2hhcmFjdGVycyhpbjogQ2hhcmFjdGVyU2V0KGNoYXJhY3RlcnNJbjogIiAiKSkKICAgICAgICBndWFyZCB0eXBlIGVsc2UgeyByZXR1cm4gc3RyaXBwZWQgfQogICAgICAgIHJldHVybiAiKFwoc3RyaXBwZWQpKS5UeXBlIgogICAgfQoKICAgIHByaXZhdGUgZnVuYyBtZXRob2RJbmZvKF8gZGVwcmVjYXRlZDogQm9vbCwgXyBhbm5vdGF0ZWQ6IEJvb2wpCiAgICAgICAgLT4gKGFubm90YXRpb246IFN0cmluZywgbWV0aG9kTmFtZTogU3RyaW5nLCBnZW5lcmljQ29uc3RyYWluczogU3RyaW5nKSB7CiAgICAgICAgICAgIGxldCBnZW5lcmljcyA9IGdldEdlbmVyaWNzQW1vbmdQYXJhbWV0ZXJzKCkKICAgICAgICAgICAgbGV0IGFubm90YXRpb24gPSBhbm5vdGF0ZWQgJiYgZGVwcmVjYXRlZCA/IGRlcHJlY2F0ZWRNZXNzYWdlKGRlcHJlY2F0ZWRQYXJhbWV0ZXJzTWVzc2FnZSgpKSA6ICIiCiAgICAgICAgICAgIGxldCBtZXRob2ROYW1lID0gcmV0dXJuVHlwZU1hdHRlcnMoKSA/IG1ldGhvZC5zaG9ydE5hbWUgOiAiXChtZXRob2QuY2FsbE5hbWUpXCh3cmFwR2VuZXJpY3MoZ2VuZXJpY3MpKSIKICAgICAgICAgICAgbGV0IGdlbmVyaWNDb25zdHJhaW5zOiBTdHJpbmcgPSB7CiAgICAgICAgICAgICAgICBsZXQgY29uc3RyYWludHMgPSBnZXRHZW5lcmljc0NvbnN0cmFpbnRzKGdlbmVyaWNzKQogICAgICAgICAgICAgICAgZ3VhcmQgIWNvbnN0cmFpbnRzLmlzRW1wdHkgZWxzZSB7IHJldHVybiAiIiB9CgogICAgICAgICAgICAgICAgcmV0dXJuICIgd2hlcmUgXChjb25zdHJhaW50cy5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKSkiCiAgICAgICAgICAgIH0oKQogICAgICAgICAgICByZXR1cm4gKGFubm90YXRpb24sIG1ldGhvZE5hbWUsIGdlbmVyaWNDb25zdHJhaW5zKQogICAgfQp9CmNsYXNzIFN1YnNjcmlwdFdyYXBwZXIgewogICAgbGV0IHdyYXBwZWQ6IFNvdXJjZXJ5UnVudGltZS5TdWJzY3JpcHQKICAgIHZhciByZWFkb25seTogQm9vbCB7IHJldHVybiAhd3JhcHBlZC5pc011dGFibGUgfQogICAgdmFyIHdyYXBwZWRQYXJhbWV0ZXJzOiBbUGFyYW1ldGVyV3JhcHBlcl0geyByZXR1cm4gd3JhcHBlZC5wYXJhbWV0ZXJzLm1hcCB7IFBhcmFtZXRlcldyYXBwZXIoJDApIH0gfQogICAgdmFyIGNhc2VzQ291bnQ6IEludCB7IHJldHVybiByZWFkb25seSA/IDEgOiAyIH0KICAgIHZhciBuZXN0ZWRUeXBlOiBTdHJpbmcgeyByZXR1cm4gIlwoVHlwZVdyYXBwZXIod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkubmVzdGVkUGFyYW1ldGVyKSIgfQogICAgbGV0IGFzc29jaWF0ZWRUeXBlczogW1N0cmluZ10/CiAgICBsZXQgZ2VuZXJpY1R5cGVzTGlzdDogW1N0cmluZ10KICAgIGxldCBnZW5lcmljVHlwZXNNb2RpZmllcjogU3RyaW5nPwoKICAgIHByaXZhdGUgbGV0IG5vU3R1YkRlZmluZWRNZXNzYWdlID0gIlN0dWIgcmV0dXJuIHZhbHVlIG5vdCBzcGVjaWZpZWQgZm9yIHN1YnNjcmlwdC4gVXNlIGdpdmVuIGZpcnN0LiIKCiAgICBwcml2YXRlIHN0YXRpYyB2YXIgcmVnaXN0ZXJlZDogW1N0cmluZzogSW50XSA9IFs6XQogICAgcHJpdmF0ZSBzdGF0aWMgdmFyIG5hbWVzV2l0aG91dFJldHVyblR5cGU6IFtTdHJpbmc6IEludF0gPSBbOl0KICAgIHByaXZhdGUgc3RhdGljIHZhciBzdWZmaXhlczogW1N0cmluZzogSW50XSA9IFs6XQogICAgcHVibGljIHN0YXRpYyBmdW5jIGNsZWFyKCkgLT4gU3RyaW5nIHsKICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLnJlZ2lzdGVyZWQgPSBbOl0KICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLnN1ZmZpeGVzID0gWzpdCiAgICAgICAgcmV0dXJuICIiCiAgICB9CiAgICBzdGF0aWMgZnVuYyByZWdpc3RlcihfIG5hbWU6IFN0cmluZywgXyB1bmlxdWVOYW1lOiBTdHJpbmcpIHsKICAgICAgICBsZXQgY291bnQgPSBTdWJzY3JpcHRXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gPz8gMAogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIucmVnaXN0ZXJlZFtuYW1lXSA9IGNvdW50ICsgMQogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIuc3VmZml4ZXNbdW5pcXVlTmFtZV0gPSBjb3VudCArIDEKICAgIH0KICAgIHN0YXRpYyBmdW5jIHJlZ2lzdGVyKHNob3J0IG5hbWU6IFN0cmluZykgewogICAgICAgIGxldCBjb3VudCA9IFN1YnNjcmlwdFdyYXBwZXIubmFtZXNXaXRob3V0UmV0dXJuVHlwZVtuYW1lXSA/PyAwCiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5uYW1lc1dpdGhvdXRSZXR1cm5UeXBlW25hbWVdID0gY291bnQgKyAxCiAgICB9CgogICAgZnVuYyByZWdpc3RlcigpIHsKICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLnJlZ2lzdGVyKHJlZ2lzdHJhdGlvbk5hbWUoImdldCIpLHVuaXF1ZU5hbWUpCiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5yZWdpc3RlcihzaG9ydDogc2hvcnROYW1lKQogICAgICAgIGd1YXJkICFyZWFkb25seSBlbHNlIHsgcmV0dXJuIH0KICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLnJlZ2lzdGVyKHJlZ2lzdHJhdGlvbk5hbWUoInNldCIpLHVuaXF1ZU5hbWUpCiAgICB9CgogICAgaW5pdChfIHdyYXBwZWQ6IFNvdXJjZXJ5UnVudGltZS5TdWJzY3JpcHQpIHsKICAgICAgICBzZWxmLndyYXBwZWQgPSB3cmFwcGVkCiAgICAgICAgYXNzb2NpYXRlZFR5cGVzID0gSGVscGVycy5leHRyYWN0QXNzb2NpYXRlZFR5cGVzKGZyb206IHdyYXBwZWQpCiAgICAgICAgZ2VuZXJpY1R5cGVzTGlzdCA9IEhlbHBlcnMuZXh0cmFjdEdlbmVyaWNzTGlzdChhc3NvY2lhdGVkVHlwZXMpCiAgICAgICAgaWYgbGV0IHR5cGVzID0gYXNzb2NpYXRlZFR5cGVzIHsKICAgICAgICAgICAgZ2VuZXJpY1R5cGVzTW9kaWZpZXIgPSAiPFwodHlwZXMuam9pbmVkKHNlcGFyYXRvcjogIiwiKSk+IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdlbmVyaWNUeXBlc01vZGlmaWVyID0gbmlsCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgcmVnaXN0cmF0aW9uTmFtZShfIGFjY2Vzc29yOiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJzdWJzY3JpcHRfXChhY2Nlc3NvcilfXCh3cmFwcGVkUGFyYW1ldGVycy5tYXAoeyAkMC5zYW5pdGl6ZWRGb3JFbnVtQ2FzZU5hbWUoKSB9KS5qb2luZWQoc2VwYXJhdG9yOiAiXyIpKSIKICAgIH0KICAgIHZhciBzaG9ydE5hbWU6IFN0cmluZyB7IHJldHVybiAicHVibGljIHN1YnNjcmlwdFwoZ2VuZXJpY1R5cGVzTW9kaWZpZXIgPz8gIiAiKShcKHdyYXBwZWRQYXJhbWV0ZXJzLm1hcCh7ICQwLmFzTWV0aG9kQXJndW1lbnQoKSB9KS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKSkpIiB9CiAgICB2YXIgdW5pcXVlTmFtZTogU3RyaW5nIHsgcmV0dXJuICJcKHNob3J0TmFtZSkgLT4gXCh3cmFwcGVkLnJldHVyblR5cGVOYW1lKSIgfQoKICAgIHByaXZhdGUgZnVuYyBuYW1lU3VmZml4KF8gYWNjZXNzb3I6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCBsZXQgY291bnQgPSBTdWJzY3JpcHRXcmFwcGVyLnJlZ2lzdGVyZWRbcmVnaXN0cmF0aW9uTmFtZShhY2Nlc3NvcildIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIGNvdW50ID4gMSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICBndWFyZCBsZXQgaW5kZXggPSBTdWJzY3JpcHRXcmFwcGVyLnN1ZmZpeGVzW3VuaXF1ZU5hbWVdIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIHJldHVybiAiX1woaW5kZXgpIgogICAgfQoKICAgIC8vIGNhbGwKICAgIGZ1bmMgc3Vic2NyaXB0Q2FsbCgpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGdldCA9ICJcblx0XHRnZXQge1woZ2V0dGVyKCkpXG5cdFx0fSIKICAgICAgICBsZXQgc2V0ID0gcmVhZG9ubHkgPyAiIiA6ICJcblx0XHRzZXQge1woc2V0dGVyKCkpXG5cdFx0fSIKICAgICAgICByZXR1cm4gIlwodW5pcXVlTmFtZSkge1woZ2V0KVwoc2V0KVxuXHR9IgogICAgfQogICAgcHJpdmF0ZSBmdW5jIGdldHRlcigpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IG1ldGhvZCA9ICIuXChzdWJzY3JpcHRDYXNlUHJlZml4KCJnZXQiKSkoXChwYXJhbWV0ZXJzRm9yTWV0aG9kQ2FsbCgpKSkiCiAgICAgICAgbGV0IG5vU3R1YkRlZmluZWQgPSB3cmFwcGVkLnJldHVyblR5cGVOYW1lLmlzT3B0aW9uYWwgPyAicmV0dXJuIG5pbCIgOiAib25GYXRhbEZhaWx1cmUoXCJcKG5vU3R1YkRlZmluZWRNZXNzYWdlKVwiKTsgRmFpbHVyZShcIm5vU3R1YkRlZmluZWRNZXNzYWdlXCIpIgogICAgICAgIHJldHVybgogICAgICAgICAgICAiXG5cdFx0XHRhZGRJbnZvY2F0aW9uKFwobWV0aG9kKSkiICsKICAgICAgICAgICAgICAgICJcblx0XHRcdGRvIHsiICsKICAgICAgICAgICAgICAgICJcblx0XHRcdFx0cmV0dXJuIHRyeSBtZXRob2RSZXR1cm5WYWx1ZShcKG1ldGhvZCkpLmNhc3RlZCgpIiArCiAgICAgICAgICAgICAgICAiXG5cdFx0XHR9IGNhdGNoIHsiICsKICAgICAgICAgICAgICAgICJcblx0XHRcdFx0XChub1N0dWJEZWZpbmVkKSIgKwogICAgICAgICJcblx0XHRcdH0iCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgc2V0dGVyKCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgbWV0aG9kID0gIi5cKHN1YnNjcmlwdENhc2VQcmVmaXgoInNldCIpKShcKHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKHNldDogdHJ1ZSkpKSIKICAgICAgICByZXR1cm4gIlxuXHRcdFx0YWRkSW52b2NhdGlvbihcKG1ldGhvZCkpIgogICAgfQoKICAgIC8vIG1ldGhvZCB0eXBlCiAgICBmdW5jIHN1YnNjcmlwdENhc2VQcmVmaXgoXyBhY2Nlc3NvcjogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChyZWdpc3RyYXRpb25OYW1lKGFjY2Vzc29yKSlcKG5hbWVTdWZmaXgoYWNjZXNzb3IpKSIKICAgIH0KICAgIGZ1bmMgc3Vic2NyaXB0Q2FzZU5hbWUoXyBhY2Nlc3NvcjogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChzdWJzY3JpcHRDYXNlUHJlZml4KGFjY2Vzc29yKSkoXChwYXJhbWV0ZXJzRm9yTWV0aG9kVHlwZURlY2xhcmF0aW9uKHNldDogYWNjZXNzb3IgPT0gInNldCIpKSkiCiAgICB9CiAgICBmdW5jIHN1YnNjcmlwdENhc2VzKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gcmVhZG9ubHkgPyAiY2FzZSBcKHN1YnNjcmlwdENhc2VOYW1lKCJnZXQiKSkiIDogImNhc2UgXChzdWJzY3JpcHRDYXNlTmFtZSgiZ2V0IikpXG5cdFx0Y2FzZSBcKHN1YnNjcmlwdENhc2VOYW1lKCJzZXQiKSkiCiAgICB9CiAgICBmdW5jIGVxdWFsQ2FzZShfIGFjY2Vzc29yOiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICAgICAgdmFyIGxoc1BhcmFtcyA9IHdyYXBwZWQucGFyYW1ldGVycy5tYXAgeyAibGhzXCgkMC5uYW1lLmNhcGl0YWxpemVkKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgIHZhciByaHNQYXJhbXMgPSB3cmFwcGVkLnBhcmFtZXRlcnMubWFwIHsgInJoc1woJDAubmFtZS5jYXBpdGFsaXplZCkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICB2YXIgY29tcGFyYXRvcnMgPSB3cmFwcGVkUGFyYW1ldGVycy5tYXAgeyAiXHRcdFx0XHRcKCQwLmNvbXBhcmF0b3IpIiB9LmpvaW5lZChzZXBhcmF0b3I6ICJcbiIpCiAgICAgICAgaWYgYWNjZXNzb3IgPT0gInNldCIgewogICAgICAgICAgICBsaHNQYXJhbXMgKz0gIiwgbGhzRGlkU2V0IgogICAgICAgICAgICByaHNQYXJhbXMgKz0gIiwgcmhzRGlkU2V0IgogICAgICAgICAgICBjb21wYXJhdG9ycyArPSAiXG5cdFx0XHRcdHJldHVybiBQYXJhbWV0ZXIuY29tcGFyZShsaHM6IGxoc0RpZFNldCwgcmhzOiByaHNEaWRTZXQsIHdpdGg6IG1hdGNoZXIpIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbXBhcmF0b3JzICs9ICJcblx0XHRcdFx0cmV0dXJuIHRydWUiCiAgICAgICAgfQogICAgICAgIHJldHVybiAiY2FzZSAobGV0IC5cKHN1YnNjcmlwdENhc2VQcmVmaXgoYWNjZXNzb3IpKShcKGxoc1BhcmFtcykpLCBsZXQgLlwoc3Vic2NyaXB0Q2FzZVByZWZpeChhY2Nlc3NvcikpKFwocmhzUGFyYW1zKSkpOlxuIiArIGNvbXBhcmF0b3JzCiAgICB9CiAgICBmdW5jIGVxdWFsQ2FzZXMoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiByZWFkb25seSA/IGVxdWFsQ2FzZSgiZ2V0IikgOiAiXChlcXVhbENhc2UoImdldCIpKVxuXHRcdFx0XChlcXVhbENhc2UoInNldCIpKSIKICAgIH0KICAgIGZ1bmMgaW50VmFsdWVDYXNlKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gcmVhZG9ubHkgPyBpbnRWYWx1ZUNhc2UoImdldCIpIDogIlwoaW50VmFsdWVDYXNlKCJnZXQiKSlcblx0XHRcdFwoaW50VmFsdWVDYXNlKCJzZXQiKSkiCiAgICB9CiAgICBmdW5jIGludFZhbHVlQ2FzZShfIGFjY2Vzc29yOiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHBhcmFtcyA9IHdyYXBwZWRQYXJhbWV0ZXJzLmVudW1lcmF0ZWQoKS5tYXAgeyBvZmZzZXQsIF8gaW4KICAgICAgICAgICAgcmV0dXJuICJwXChvZmZzZXQpIgogICAgICAgIH0KICAgICAgICBsZXQgZGVmaW5pdGlvbnMgPSBwYXJhbXMuam9pbmVkKHNlcGFyYXRvcjogIiwgIikgKyAoYWNjZXNzb3IgPT0gInNldCIgPyAiLCBfIiA6ICIiKQogICAgICAgIGxldCBwYXJhbXNTdW0gPSBwYXJhbXMubWFwKHsgIlwoJDApLmludFZhbHVlIiB9KS5qb2luZWQoc2VwYXJhdG9yOiAiICsgIikKICAgICAgICByZXR1cm4gImNhc2UgbGV0IC5cKHN1YnNjcmlwdENhc2VQcmVmaXgoYWNjZXNzb3IpKShcKGRlZmluaXRpb25zKSk6IHJldHVybiBcKHBhcmFtc1N1bSkiCiAgICB9CgogICAgLy8gR2l2ZW4KICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlU3RyaW5nID0gcmV0dXJuc1NlbGYgPyByZXBsYWNlU2VsZiA6IFR5cGVXcmFwcGVyKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkCiAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgYHN1YnNjcmlwdGBcKGdlbmVyaWNUeXBlc01vZGlmaWVyID8/ICIiKShcKHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZSgpKSwgd2lsbFJldHVybjogXChyZXR1cm5UeXBlU3RyaW5nKS4uLikgLT4gU3Vic2NyaXB0U3R1YiIKICAgIH0KICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3RvcigpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJyZXR1cm4gR2l2ZW4obWV0aG9kOiAuXChzdWJzY3JpcHRDYXNlUHJlZml4KCJnZXQiKSkoXChwYXJhbWV0ZXJzRm9yUHJveHlJbml0KCkpKSwgcHJvZHVjdHM6IHdpbGxSZXR1cm4ubWFwKHsgU3R1YlByb2R1Y3QucmV0dXJuKCQwIGFzIEFueSkgfSkpIgogICAgfQoKICAgIC8vIFZlcmlmeQogICAgZnVuYyB2ZXJpZnlDb25zdHJ1Y3Rvck5hbWUoc2V0OiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVTdHJpbmcgPSByZXR1cm5zU2VsZiA/IHJlcGxhY2VTZWxmIDogbmVzdGVkVHlwZQogICAgICAgIGxldCByZXR1cm5pbmcgPSBzZXQgPyAiIiA6IHJldHVybmluZ1BhcmFtZXRlcih0cnVlLCB0cnVlKQogICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIGBzdWJzY3JpcHRgXChnZW5lcmljVHlwZXNNb2RpZmllciA/PyAiIikoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoKSlcKHJldHVybmluZylcKHNldCA/ICIsIHNldCBuZXdWYWx1ZTogXChyZXR1cm5UeXBlU3RyaW5nKSIgOiAiIikpIC0+IFZlcmlmeSIKICAgIH0KICAgIGZ1bmMgdmVyaWZ5Q29uc3RydWN0b3Ioc2V0OiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJyZXR1cm4gVmVyaWZ5KG1ldGhvZDogLlwoc3Vic2NyaXB0Q2FzZVByZWZpeChzZXQgPyAic2V0IiA6ICJnZXQiKSkoXChwYXJhbWV0ZXJzRm9yUHJveHlJbml0KHNldDogc2V0KSkpKSIKICAgIH0KCiAgICAvLyBHZW5lcmljcwogICAgcHJpdmF0ZSBmdW5jIGdldEdlbmVyaWNzKCkgLT4gW1N0cmluZ10gewogICAgICAgIHJldHVybiBnZW5lcmljVHlwZXNMaXN0CiAgICB9CgogICAgLy8gSGVscGVycwogICAgcHJpdmF0ZSB2YXIgcmV0dXJuc1NlbGY6IEJvb2wgeyByZXR1cm4gVHlwZVdyYXBwZXIod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkuaXNTZWxmVHlwZSB9CiAgICBwcml2YXRlIHZhciByZXBsYWNlU2VsZjogU3RyaW5nIHsgcmV0dXJuIEN1cnJlbnQuc2VsZlR5cGUgfQogICAgcHJpdmF0ZSBmdW5jIHJldHVyblR5cGVTdHJpcHBlZCh0eXBlOiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVSYXcgPSAiXCh3cmFwcGVkLnJldHVyblR5cGVOYW1lKSIKICAgICAgICB2YXIgc3RyaXBwZWQ6IFN0cmluZyA9IHsKICAgICAgICAgICAgZ3VhcmQgbGV0IHJhbmdlID0gcmV0dXJuVHlwZVJhdy5yYW5nZShvZjogIndoZXJlIikgZWxzZSB7IHJldHVybiByZXR1cm5UeXBlUmF3IH0KICAgICAgICAgICAgdmFyIHN0cmlwcGVkID0gcmV0dXJuVHlwZVJhdwogICAgICAgICAgICBzdHJpcHBlZC5yZW1vdmVTdWJyYW5nZSgocmFuZ2UubG93ZXJCb3VuZCkuLi4pCiAgICAgICAgICAgIHJldHVybiBzdHJpcHBlZAogICAgICAgIH0oKQogICAgICAgIHN0cmlwcGVkID0gc3RyaXBwZWQudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiICIpKQogICAgICAgIGd1YXJkIHR5cGUgZWxzZSB7IHJldHVybiBzdHJpcHBlZCB9CiAgICAgICAgcmV0dXJuICIoXChzdHJpcHBlZCkpLlR5cGUiCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgcmV0dXJuVHlwZU1hdHRlcnMoKSAtPiBCb29sIHsKICAgICAgICBsZXQgY291bnQgPSBTdWJzY3JpcHRXcmFwcGVyLm5hbWVzV2l0aG91dFJldHVyblR5cGVbc2hvcnROYW1lXSA/PyAwCiAgICAgICAgcmV0dXJuIGNvdW50ID4gMQogICAgfQoKICAgIC8vIHBhcmFtcwogICAgcHJpdmF0ZSBmdW5jIHJldHVybmluZ1BhcmFtZXRlcihfIG11bHRpcGxlOiBCb29sLCBfIGZyb250OiBCb29sKSAtPiBTdHJpbmcgewogICAgICAgIGd1YXJkIHJldHVyblR5cGVNYXR0ZXJzKCkgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgbGV0IHJldHVybmluZzogU3RyaW5nID0gInJldHVybmluZzogXChyZXR1cm5UeXBlU3RyaXBwZWQodHlwZTogdHJ1ZSkpIgogICAgICAgIGd1YXJkIG11bHRpcGxlIGVsc2UgeyByZXR1cm4gcmV0dXJuaW5nIH0KICAgICAgICByZXR1cm4gZnJvbnQgPyAiLCBcKHJldHVybmluZykiIDogIlwocmV0dXJuaW5nKSwgIgogICAgfQogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JNZXRob2RUeXBlRGVjbGFyYXRpb24oc2V0OiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGdlbmVyaWNzOiBbU3RyaW5nXSA9IGdldEdlbmVyaWNzKCkKICAgICAgICBsZXQgcGFyYW1zID0gd3JhcHBlZFBhcmFtZXRlcnMubWFwIHsgcGFyYW0gaW4KICAgICAgICAgICAgcmV0dXJuIHBhcmFtLmlzR2VuZXJpYyhnZW5lcmljcykgPyBwYXJhbS5nZW5lcmljVHlwZSA6IHBhcmFtLm5lc3RlZFR5cGUKICAgICAgICAgICAgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgIGd1YXJkIHNldCBlbHNlIHsgcmV0dXJuIHBhcmFtcyB9CiAgICAgICAgbGV0IG5ld1ZhbHVlID0gVHlwZVdyYXBwZXIod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkuaXNHZW5lcmljKGdlbmVyaWNzKSA/ICJQYXJhbWV0ZXI8R2VuZXJpY0F0dHJpYnV0ZT4iIDogbmVzdGVkVHlwZQogICAgICAgIHJldHVybiAiXChwYXJhbXMpLCBcKG5ld1ZhbHVlKSIKICAgIH0KICAgIHByaXZhdGUgZnVuYyBwYXJhbWV0ZXJzRm9yUHJveHlJbml0KHNldDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZW5lcmljcyA9IGdldEdlbmVyaWNzKCkKICAgICAgICBsZXQgbmV3VmFsdWUgPSBUeXBlV3JhcHBlcih3cmFwcGVkLnJldHVyblR5cGVOYW1lKS5pc0dlbmVyaWMoZ2VuZXJpY3MpID8gIm5ld1ZhbHVlLndyYXBBc0dlbmVyaWMoKSIgOiAibmV3VmFsdWUiCiAgICAgICAgcmV0dXJuIHdyYXBwZWRQYXJhbWV0ZXJzLm1hcCB7ICJcKCQwLndyYXBwZWRGb3JQcm94eShnZW5lcmljcykpIiB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpICsgKHNldCA/ICIsIFwobmV3VmFsdWUpIiA6ICIiKQogICAgfQogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZShzZXQ6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gd3JhcHBlZFBhcmFtZXRlcnMubWFwIHsgIlwoJDAubGFiZWxBbmROYW1lKCkpOiBcKCQwLm5lc3RlZFR5cGUpIiB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpICsgKHNldCA/ICIsIHNldCBuZXdWYWx1ZTogXChuZXN0ZWRUeXBlKSIgOiAiIikKICAgIH0KICAgIHByaXZhdGUgZnVuYyBwYXJhbWV0ZXJzRm9yTWV0aG9kQ2FsbChzZXQ6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgZ2VuZXJpY3MgPSBnZXRHZW5lcmljcygpCiAgICAgICAgbGV0IHBhcmFtcyA9IHdyYXBwZWRQYXJhbWV0ZXJzLm1hcCB7ICQwLndyYXBwZWRGb3JDYWxscyhnZW5lcmljcykgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgIGxldCBwb3N0Zml4ID0gVHlwZVdyYXBwZXIod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkuaXNHZW5lcmljKGdlbmVyaWNzKSA/ICIud3JhcEFzR2VuZXJpYygpIiA6ICIiCiAgICAgICAgcmV0dXJuICFzZXQgPyBwYXJhbXMgOiAiXChwYXJhbXMpLCBcKG5lc3RlZFR5cGUpLnZhbHVlKG5ld1ZhbHVlKVwocG9zdGZpeCkiCiAgICB9Cn0KY2xhc3MgVmFyaWFibGVXcmFwcGVyIHsKICAgIGxldCB2YXJpYWJsZTogU291cmNlcnlSdW50aW1lLlZhcmlhYmxlCiAgICBsZXQgc2NvcGU6IFN0cmluZwogICAgdmFyIHJlYWRvbmx5OiBCb29sIHsgcmV0dXJuIHZhcmlhYmxlLndyaXRlQWNjZXNzLmlzRW1wdHkgfQogICAgdmFyIHByaXZhdGVQcm90b3R5cGVOYW1lOiBTdHJpbmcgeyByZXR1cm4gIl9fcF9cKHZhcmlhYmxlLm5hbWUpIi5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogImAiLCB3aXRoOiAiIikgfQogICAgdmFyIGNhc2VzQ291bnQ6IEludCB7IHJldHVybiByZWFkb25seSA/IDEgOiAyIH0KCiAgICBsZXQgZGVwcmVjYXRlZE1lc3NhZ2UgPSAiVXNpbmcgc2V0dGVycyBvbiByZWFkb25seSB2YXJpYWJsZXMgaXMgZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiAzLjEuIFVzZSBHaXZlbiB0byBkZWZpbmUgc3R1YmJlZCBwcm9wZXJ0eSByZXR1cm4gdmFsdWUuIgogICAgdmFyIG5vU3R1YkRlZmluZWRNZXNzYWdlOiBTdHJpbmcgeyByZXR1cm4gIlwoc2NvcGUpIC0gc3R1YiB2YWx1ZSBmb3IgXCh2YXJpYWJsZS5uYW1lKSB3YXMgbm90IGRlZmluZWQiIH0KCiAgICB2YXIgZ2V0dGVyOiBTdHJpbmcgewogICAgICAgIGxldCBzdGF0aWNNb2RpZmllciA9IHZhcmlhYmxlLmlzU3RhdGljID8gIlwoc2NvcGUpLiIgOiAiIgogICAgICAgIGxldCByZXR1cm5WYWx1ZSA9IHZhcmlhYmxlLmlzT3B0aW9uYWwgPyAib3B0aW9uYWxHaXZlbkdldHRlclZhbHVlKC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpLCBcIlwobm9TdHViRGVmaW5lZE1lc3NhZ2UpXCIpIiA6ICJnaXZlbkdldHRlclZhbHVlKC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpLCBcIlwobm9TdHViRGVmaW5lZE1lc3NhZ2UpXCIpIgogICAgICAgIHJldHVybiAiXG5cdFx0Z2V0IHtcdFwoc3RhdGljTW9kaWZpZXIpaW52b2NhdGlvbnMuYXBwZW5kKC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpKTsgcmV0dXJuIFwoc3RhdGljTW9kaWZpZXIpXChwcml2YXRlUHJvdG90eXBlTmFtZSkgPz8gXChyZXR1cm5WYWx1ZSkgfSIKICAgIH0KICAgIHZhciBzZXR0ZXI6IFN0cmluZyB7CiAgICAgICAgbGV0IHN0YXRpY01vZGlmaWVyID0gdmFyaWFibGUuaXNTdGF0aWMgPyAiXChzY29wZSkuIiA6ICIiCiAgICAgICAgaWYgcmVhZG9ubHkgewogICAgICAgICAgICBsZXQgYW5ub3RhdGlvbiA9IHJlYWRvbmx5ID8gIlxuXHRcdEBhdmFpbGFibGUoKiwgZGVwcmVjYXRlZCwgbWVzc2FnZTogXCJcKGRlcHJlY2F0ZWRNZXNzYWdlKVwiKSIgOiAiIgogICAgICAgICAgICByZXR1cm4gIlwoYW5ub3RhdGlvbilcblx0XHRzZXQge1x0XCh2YXJpYWJsZS5pc1N0YXRpYyA/ICJcKHNjb3BlKS4iIDogIiIpXChwcml2YXRlUHJvdG90eXBlTmFtZSkgPSBuZXdWYWx1ZSB9IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiXG5cdFx0c2V0IHtcdFwoc3RhdGljTW9kaWZpZXIpaW52b2NhdGlvbnMuYXBwZW5kKC5cKHByb3BlcnR5Q2FzZVNldE5hbWUpKC52YWx1ZShuZXdWYWx1ZSkpKTsgXCh2YXJpYWJsZS5pc1N0YXRpYyA/ICJcKHNjb3BlKS4iIDogIiIpXChwcml2YXRlUHJvdG90eXBlTmFtZSkgPSBuZXdWYWx1ZSB9IgogICAgICAgIH0KICAgIH0KICAgIHZhciBwcm90b3R5cGU6IFN0cmluZyB7CiAgICAgICAgbGV0IHN0YXRpY01vZGlmaWVyID0gdmFyaWFibGUuaXNTdGF0aWMgPyAic3RhdGljICIgOiAiIgoKICAgICAgICByZXR1cm4gInB1YmxpYyBcKHN0YXRpY01vZGlmaWVyKXZhciBcKHZhcmlhYmxlLm5hbWUpOiBcKHZhcmlhYmxlLnR5cGVOYW1lLm5hbWUpIHsiICsKICAgICAgICAgICAgIlwoZ2V0dGVyKSIgKwogICAgICAgICAgICAiXChzZXR0ZXIpIiArCiAgICAgICAgIlxuXHR9IgogICAgfQoKICAgIHZhciBwcml2YXRlUHJvdG90eXBlOiBTdHJpbmcgewogICAgICAgIGxldCBzdGF0aWNNb2RpZmllciA9IHZhcmlhYmxlLmlzU3RhdGljID8gInN0YXRpYyAiIDogIiIKICAgICAgICByZXR1cm4gInByaXZhdGUgXChzdGF0aWNNb2RpZmllcil2YXIgXChwcml2YXRlUHJvdG90eXBlTmFtZSk6IChcKHZhcmlhYmxlLnR5cGVOYW1lLnVud3JhcHBlZFR5cGVOYW1lKSk/IgogICAgfQogICAgdmFyIG5lc3RlZFR5cGU6IFN0cmluZyB7IHJldHVybiAiXChUeXBlV3JhcHBlcih2YXJpYWJsZS50eXBlTmFtZSkubmVzdGVkUGFyYW1ldGVyKSIgfQoKICAgIGluaXQoXyB2YXJpYWJsZTogU291cmNlcnlSdW50aW1lLlZhcmlhYmxlLCBzY29wZTogU3RyaW5nKSB7CiAgICAgICAgc2VsZi52YXJpYWJsZSA9IHZhcmlhYmxlCiAgICAgICAgc2VsZi5zY29wZSA9IHNjb3BlCiAgICB9CgogICAgZnVuYyBwcm9wZXJ0eUdldCgpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHN0YXRpY01vZGlmaWVyID0gdmFyaWFibGUuaXNTdGF0aWMgPyAiU3RhdGljIiA6ICIiCiAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIHZhciBcKHZhcmlhYmxlLm5hbWUpOiBcKHN0YXRpY01vZGlmaWVyKVZlcmlmeSB7IHJldHVybiBcKHN0YXRpY01vZGlmaWVyKVZlcmlmeShtZXRob2Q6IC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpKSB9IgogICAgfQoKICAgIGZ1bmMgcHJvcGVydHlTZXQoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBzdGF0aWNNb2RpZmllciA9IHZhcmlhYmxlLmlzU3RhdGljID8gIlN0YXRpYyIgOiAiIgogICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwodmFyaWFibGUubmFtZSkoc2V0IG5ld1ZhbHVlOiBcKG5lc3RlZFR5cGUpKSAtPiBcKHN0YXRpY01vZGlmaWVyKVZlcmlmeSB7IHJldHVybiBcKHN0YXRpY01vZGlmaWVyKVZlcmlmeShtZXRob2Q6IC5cKHByb3BlcnR5Q2FzZVNldE5hbWUpKG5ld1ZhbHVlKSkgfSIKICAgIH0KCiAgICB2YXIgcHJvcGVydHlDYXNlR2V0TmFtZTogU3RyaW5nIHsgcmV0dXJuICJwX1wodmFyaWFibGUubmFtZSlfZ2V0Ii5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogImAiLCB3aXRoOiAiIikgfQogICAgZnVuYyBwcm9wZXJ0eUNhc2VHZXQoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiY2FzZSBcKHByb3BlcnR5Q2FzZUdldE5hbWUpIgogICAgfQogICAgZnVuYyBwcm9wZXJ0eUNhc2VHZXRDb21wYXJlKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gImNhc2UgKC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpLC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpKTogcmV0dXJuIHRydWUiCiAgICB9CiAgICBmdW5jIHByb3BlcnR5Q2FzZUdldEludFZhbHVlKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gImNhc2UgLlwocHJvcGVydHlDYXNlR2V0TmFtZSk6IHJldHVybiAwIgogICAgfQoKICAgIHZhciBwcm9wZXJ0eUNhc2VTZXROYW1lOiBTdHJpbmcgeyByZXR1cm4gInBfXCh2YXJpYWJsZS5uYW1lKV9zZXQiLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiYCIsIHdpdGg6ICIiKSB9CiAgICBmdW5jIHByb3BlcnR5Q2FzZVNldCgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJjYXNlIFwocHJvcGVydHlDYXNlU2V0TmFtZSkoXChuZXN0ZWRUeXBlKSkiCiAgICB9CiAgICBmdW5jIHByb3BlcnR5Q2FzZVNldENvbXBhcmUoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiY2FzZSAoLlwocHJvcGVydHlDYXNlU2V0TmFtZSkobGV0IGxlZnQpLC5cKHByb3BlcnR5Q2FzZVNldE5hbWUpKGxldCByaWdodCkpOiByZXR1cm4gXChuZXN0ZWRUeXBlKS5jb21wYXJlKGxoczogbGVmdCwgcmhzOiByaWdodCwgd2l0aDogbWF0Y2hlcikiCiAgICB9CiAgICBmdW5jIHByb3BlcnR5Q2FzZVNldEludFZhbHVlKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gImNhc2UgLlwocHJvcGVydHlDYXNlU2V0TmFtZSkobGV0IG5ld1ZhbHVlKTogcmV0dXJuIG5ld1ZhbHVlLmludFZhbHVlIgogICAgfQoKICAgIC8vIEdpdmVuCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3JOYW1lKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXCh2YXJpYWJsZS5uYW1lKShnZXR0ZXIgZGVmYXVsdFZhbHVlOiBcKFR5cGVXcmFwcGVyKHZhcmlhYmxlLnR5cGVOYW1lKS5zdHJpcHBlZCkuLi4pIC0+IFwocHJlZml4KVByb3BlcnR5U3R1YiIKICAgIH0KCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3IocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClHaXZlbihtZXRob2Q6IC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpLCBwcm9kdWN0czogZGVmYXVsdFZhbHVlLm1hcCh7IFN0dWJQcm9kdWN0LnJldHVybigkMCBhcyBBbnkpIH0pKSIKICAgIH0KfQpfJT4KPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFNFVFVQIC0lPjwlXyAtJT4KPCVfIHZhciBhbGwgPSB0eXBlcy5hbGwKICAgIGFsbCArPSB0eXBlcy5wcm90b2NvbHMubWFwIHsgJDAgfSAKICAgIHZhciBtb2NrZWRDb3VudCA9IDAKLSU+Cgo8JV8gZm9yIHR5cGUgaW4gYWxsIHsgLSU+PCVfIC0lPgo8JV8gbGV0IGF1dG9Nb2NrYWJsZTogQm9vbCA9IHR5cGUuaW5oZXJpdGVkVHlwZXMuY29udGFpbnMoIkF1dG9Nb2NrYWJsZSIpIHx8IHR5cGUuYW5ub3RhdGlvbnNbIkF1dG9Nb2NrYWJsZSJdICE9IG5pbAogICAgbGV0IHByb3RvY29sVG9EZWNvcmF0ZSA9IHR5cGVzLnByb3RvY29scy5maXJzdCh3aGVyZTogeyAkMC5uYW1lID09ICh0eXBlLmFubm90YXRpb25zWyJtb2NrIl0gYXM/IFN0cmluZykgfSkKICAgIGxldCBpbmxpbmVNb2NrYWJsZSA9IHByb3RvY29sVG9EZWNvcmF0ZSAhPSBuaWwKICAgIGd1YXJkIGxldCBhUHJvdG9jb2wgPSBhdXRvTW9ja2FibGUgPyB0eXBlIDogcHJvdG9jb2xUb0RlY29yYXRlIGVsc2UgeyBjb250aW51ZSB9CiAgICBtb2NrZWRDb3VudCArPSAxCiAgICBsZXQgYXNzb2NpYXRlZFR5cGVzOiBbU3RyaW5nXT8gPSBIZWxwZXJzLmV4dHJhY3RBc3NvY2lhdGVkVHlwZXMoZnJvbTogYVByb3RvY29sKQogICAgbGV0IGdlbmVyaWNUeXBlc01vZGlmaWVyOiBTdHJpbmcgPSBIZWxwZXJzLmV4dHJhY3RHZW5lcmljVHlwZXNNb2RpZmllcihhc3NvY2lhdGVkVHlwZXMpCiAgICBsZXQgZ2VuZXJpY1R5cGVzQ29uc3RyYWludHM6IFN0cmluZyA9IEhlbHBlcnMuZXh0cmFjdEdlbmVyaWNUeXBlc0NvbnN0cmFpbnRzKGFzc29jaWF0ZWRUeXBlcykKICAgIGxldCBhbGxTdWJzY3JpcHRzID0gYVByb3RvY29sLmFsbFN1YnNjcmlwdHMKICAgIGxldCBhbGxWYXJpYWJsZXMgPSB1bmlxdWVzKHZhcmlhYmxlczogYVByb3RvY29sLmFsbFZhcmlhYmxlcy5maWx0ZXIoeyAhJDAuaXNTdGF0aWMgfSkpCiAgICBsZXQgY29udGFpbnNWYXJpYWJsZXMgPSAhYWxsVmFyaWFibGVzLmlzRW1wdHkKICAgIGxldCBhbGxTdGF0aWNWYXJpYWJsZXMgPSB1bmlxdWVzKHZhcmlhYmxlczogYVByb3RvY29sLmFsbFZhcmlhYmxlcy5maWx0ZXIoeyAkMC5pc1N0YXRpYyB9KSkKICAgIGxldCBjb250YWluc1N0YXRpY1ZhcmlhYmxlcyA9ICFhbGxTdGF0aWNWYXJpYWJsZXMuaXNFbXB0eQogICAgbGV0IGFsbE1ldGhvZHMgPSB1bmlxdWVzKG1ldGhvZHM6IGFQcm90b2NvbC5hbGxNZXRob2RzLmZpbHRlcih7ICEkMC5pc1N0YXRpYyB9KSkKICAgIGxldCBhY2Nlc3NNb2RpZmllcjogU3RyaW5nID0gewogICAgICAgIGxldCBzZWxmQ29uc3RyYWluZWQgPSBhbGxNZXRob2RzLm1hcCh3cmFwTWV0aG9kKS5jb250YWlucyh3aGVyZTogeyAkMC5yZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmIHx8ICQwLnBhcmFtZXRlcnNDb250YWluc1NlbGYgfSkKICAgICAgICByZXR1cm4gc2VsZkNvbnN0cmFpbmVkID8gInB1YmxpYyBmaW5hbCIgOiAib3BlbiIKICAgIH0oKQogICAgbGV0IGFsbE1ldGhvZHNGb3JNZXRob2RUeXBlID0gdW5pcXVlc1dpdGhvdXRHZW5lcmljQ29uc3RyYWludHMobWV0aG9kczogYVByb3RvY29sLmFsbE1ldGhvZHMuZmlsdGVyKHsgISQwLmlzU3RhdGljIH0pKQogICAgbGV0IGFsbFN0YXRpY01ldGhvZHMgPSB1bmlxdWVzKG1ldGhvZHM6IGFQcm90b2NvbC5hbGxNZXRob2RzLmZpbHRlcih7ICQwLmlzU3RhdGljIH0pKQogICAgbGV0IGFsbFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlID0gdW5pcXVlc1dpdGhvdXRHZW5lcmljQ29uc3RyYWludHMobWV0aG9kczogYVByb3RvY29sLmFsbE1ldGhvZHMuZmlsdGVyKHsgJDAuaXNTdGF0aWMgfSkpCiAgICBsZXQgY29uZm9ybXNUb1N0YXRpY01vY2sgPSAhYWxsU3RhdGljTWV0aG9kcy5pc0VtcHR5IHx8ICFhbGxTdGF0aWNWYXJpYWJsZXMuaXNFbXB0eQogICAgbGV0IGNvbmZvcm1zVG9Nb2NrID0gIWFsbE1ldGhvZHMuaXNFbXB0eSB8fCAhYWxsVmFyaWFibGVzLmlzRW1wdHkgLSU+PCVfIC0lPjwlXyAtJT4KPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgovLyBNQVJLOiAtIDwlPSB0eXBlLm5hbWUgJT4KPCU9IGFjY2Vzc01vZGlmaWVyICU+IGNsYXNzIDwlPSB0eXBlLm5hbWUgJT5Nb2NrPCU9IGdlbmVyaWNUeXBlc01vZGlmaWVyICU+OjwlPSB0eXBlLmFubm90YXRpb25zWyJPYmpjUHJvdG9jb2wiXSAhPSBuaWwgPyAiIE5TT2JqZWN0LCIgOiAiIiAlPiA8JT0gdHlwZS5uYW1lICU+LCBNb2NrPCU9IGNvbmZvcm1zVG9TdGF0aWNNb2NrID8gIiwgU3RhdGljTW9jayIgOiAiIiAlPjwlPSBnZW5lcmljVHlwZXNDb25zdHJhaW50cyAlPiB7CiAgICBpbml0KHNlcXVlbmNpbmcgc2VxdWVuY2luZ1BvbGljeTogU2VxdWVuY2luZ1BvbGljeSA9IC5sYXN0V3JpdHRlblJlc29sdmVkRmlyc3QsIHN0dWJiaW5nIHN0dWJiaW5nUG9saWN5OiBTdHViYmluZ1BvbGljeSA9IC53cmFwLCBmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgU3dpZnR5TW9ja3lUZXN0T2JzZXJ2ZXIuc2V0dXAoKQogICAgICAgIHNlbGYuc2VxdWVuY2luZ1BvbGljeSA9IHNlcXVlbmNpbmdQb2xpY3kKICAgICAgICBzZWxmLnN0dWJiaW5nUG9saWN5ID0gc3R1YmJpbmdQb2xpY3kKICAgICAgICBzZWxmLmZpbGUgPSBmaWxlCiAgICAgICAgc2VsZi5saW5lID0gbGluZQogICAgfQoKPCVfIH0gZWxzZSB7IC0lPgovLyBzb3VyY2VyeTppbmxpbmU6YXV0bzo8JT0gdHlwZS5uYW1lICU+LmF1dG9Nb2NrZWQKPCVfIH0gLSU+CjwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBNQUlOIENMQVNTIC0lPjwlXyAtJT4KICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gTU9DSyBJTlRFUk5BTFMgLSU+PCVfIC0lPgogICAgdmFyIG1hdGNoZXI6IE1hdGNoZXIgPSBNYXRjaGVyLmRlZmF1bHQKICAgIHZhciBzdHViYmluZ1BvbGljeTogU3R1YmJpbmdQb2xpY3kgPSAud3JhcAogICAgdmFyIHNlcXVlbmNpbmdQb2xpY3k6IFNlcXVlbmNpbmdQb2xpY3kgPSAubGFzdFdyaXR0ZW5SZXNvbHZlZEZpcnN0CiAgICBwcml2YXRlIHZhciBpbnZvY2F0aW9uczogW01ldGhvZFR5cGVdID0gW10KICAgIHByaXZhdGUgdmFyIG1ldGhvZFJldHVyblZhbHVlczogW0dpdmVuXSA9IFtdCiAgICBwcml2YXRlIHZhciBtZXRob2RQZXJmb3JtVmFsdWVzOiBbUGVyZm9ybV0gPSBbXQogICAgcHJpdmF0ZSB2YXIgZmlsZTogU3RhdGljU3RyaW5nPwogICAgcHJpdmF0ZSB2YXIgbGluZTogVUludD8KCiAgICBwdWJsaWMgdHlwZWFsaWFzIFByb3BlcnR5U3R1YiA9IEdpdmVuCiAgICBwdWJsaWMgdHlwZWFsaWFzIE1ldGhvZFN0dWIgPSBHaXZlbgogICAgcHVibGljIHR5cGVhbGlhcyBTdWJzY3JpcHRTdHViID0gR2l2ZW4KCiAgICAvLy8gQ29udmVuaWVuY2UgbWV0aG9kIC0gY2FsbCBzZXR1cE1vY2soKSB0byBleHRlbmQgZGVidWcgaW5mb3JtYXRpb24gd2hlbiBmYWlsdXJlIG9jY3VycwogICAgcHVibGljIGZ1bmMgc2V0dXBNb2NrKGZpbGU6IFN0YXRpY1N0cmluZyA9ICNmaWxlLCBsaW5lOiBVSW50ID0gI2xpbmUpIHsKICAgICAgICBzZWxmLmZpbGUgPSBmaWxlCiAgICAgICAgc2VsZi5saW5lID0gbGluZQogICAgfQogICAgPCVfIC0lPgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTVEFUSUMgTU9DSyBJTlRFUk5BTFMgLSU+PCVfIC0lPgogICAgPCVfIGlmIGNvbmZvcm1zVG9TdGF0aWNNb2NrIHsgLSU+CiAgICBzdGF0aWMgdmFyIG1hdGNoZXI6IE1hdGNoZXIgPSBNYXRjaGVyLmRlZmF1bHQKICAgIHN0YXRpYyB2YXIgc3R1YmJpbmdQb2xpY3k6IFN0dWJiaW5nUG9saWN5ID0gLndyYXAKICAgIHN0YXRpYyB2YXIgc2VxdWVuY2luZ1BvbGljeTogU2VxdWVuY2luZ1BvbGljeSA9IC5sYXN0V3JpdHRlblJlc29sdmVkRmlyc3QKICAgIHN0YXRpYyBwcml2YXRlIHZhciBpbnZvY2F0aW9uczogW1N0YXRpY01ldGhvZFR5cGVdID0gW10KICAgIHN0YXRpYyBwcml2YXRlIHZhciBtZXRob2RSZXR1cm5WYWx1ZXM6IFtTdGF0aWNHaXZlbl0gPSBbXQogICAgc3RhdGljIHByaXZhdGUgdmFyIG1ldGhvZFBlcmZvcm1WYWx1ZXM6IFtTdGF0aWNQZXJmb3JtXSA9IFtdCiAgICBwdWJsaWMgdHlwZWFsaWFzIFN0YXRpY1Byb3BlcnR5U3R1YiA9IFN0YXRpY0dpdmVuCiAgICBwdWJsaWMgdHlwZWFsaWFzIFN0YXRpY01ldGhvZFN0dWIgPSBTdGF0aWNHaXZlbgogICAgcHVibGljIHN0YXRpYyBmdW5jIGNsZWFyKCkgewogICAgICAgIGludm9jYXRpb25zID0gW10KICAgICAgICBtZXRob2RSZXR1cm5WYWx1ZXMgPSBbXQogICAgICAgIG1ldGhvZFBlcmZvcm1WYWx1ZXMgPSBbXQogICAgfQogICAgPCVfICB9IC0lPgoKICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gVkFSSUFCTEVTIC0lPjwlXyAtJT4KICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsVmFyaWFibGVzIHsgLSU+CiAgICA8JV8gaWYgYXV0b01vY2thYmxlIHsgLSU+CiAgICA8JT0gc3R1YlByb3BlcnR5KHZhcmlhYmxlLCJcKHR5cGUubmFtZSlNb2NrIikgJT4KICAgIDwlXyB9IGVsc2UgeyAlPgogICAgPCU9IHN0dWJQcm9wZXJ0eSh2YXJpYWJsZSwiXCh0eXBlLm5hbWUpIikgJT4KICAgIDwlXyB9ICU+CiAgICA8JV8gfSAlPiA8JV8gLSU+CgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTVEFUSUMgVkFSSUFCTEVTIC0lPjwlXyAtJT4KICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsU3RhdGljVmFyaWFibGVzIHsgLSU+CiAgICA8JV8gaWYgYXV0b01vY2thYmxlIHsgLSU+CiAgICA8JT0gc3R1YlByb3BlcnR5KHZhcmlhYmxlLCJcKHR5cGUubmFtZSlNb2NrIikgJT4KICAgIDwlXyB9IGVsc2UgeyAlPgogICAgPCU9IHN0dWJQcm9wZXJ0eSh2YXJpYWJsZSwiXCh0eXBlLm5hbWUpIikgJT4KICAgIDwlXyB9ICU+CiAgICA8JV8gfSAlPiA8JV8gLSU+CgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBNRVRIT0QgUkVHSVNUUkFUSU9OUyAtJT48JV8gLSU+CiAgICA8JV8gTWV0aG9kV3JhcHBlci5jbGVhcigpIC0lPgogICAgPCVfIFN1YnNjcmlwdFdyYXBwZXIuY2xlYXIoKSAtJT4KICAgIDwlXyBpZiBhdXRvTW9ja2FibGUgeyAtJT4KICAgIDwlXyBDdXJyZW50LnNlbGZUeXBlID0gIlwodHlwZS5uYW1lKU1vY2tcKGdlbmVyaWNUeXBlc01vZGlmaWVyKSIgLSU+CiAgICA8JV8gfSBlbHNlIHsgJT4KICAgIDwlXyBDdXJyZW50LnNlbGZUeXBlID0gIlwodHlwZS5uYW1lKU1vY2tcKGdlbmVyaWNUeXBlc01vZGlmaWVyKSIgLSU+CiAgICA8JV8gfSAlPgogICAgPCVfIGxldCB3cmFwcGVkU3Vic2NyaXB0cyA9IGFsbFN1YnNjcmlwdHMubWFwKHdyYXBTdWJzY3JpcHQpIC0lPgogICAgPCVfIGxldCB3cmFwcGVkTWV0aG9kcyA9IGFsbE1ldGhvZHMubWFwKHdyYXBNZXRob2QpLmZpbHRlcih7ICQwLndyYXBwZWRJbk1ldGhvZFR5cGUoKSB9KSAtJT4KICAgIDwlXyBsZXQgd3JhcHBlZFZhcmlhYmxlcyA9IGFsbFZhcmlhYmxlcy5tYXAoanVzdFdyYXApIC0lPgogICAgPCVfIGxldCB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUgPSBhbGxNZXRob2RzRm9yTWV0aG9kVHlwZS5tYXAod3JhcE1ldGhvZCkuZmlsdGVyKHsgJDAud3JhcHBlZEluTWV0aG9kVHlwZSgpIH0pIC0lPgogICAgPCVfIGxldCB3cmFwcGVkSW5pdGlhbGl6ZXJzID0gYWxsTWV0aG9kcy5tYXAod3JhcE1ldGhvZCkuZmlsdGVyKHsgJDAubWV0aG9kLmlzSW5pdGlhbGl6ZXIgfSkgLSU+CiAgICA8JV8gbGV0IHdyYXBwZWRTdGF0aWNNZXRob2RzID0gYWxsU3RhdGljTWV0aG9kcy5tYXAod3JhcE1ldGhvZCkuZmlsdGVyKHsgJDAud3JhcHBlZEluTWV0aG9kVHlwZSgpIH0pIC0lPgogICAgPCVfIGxldCB3cmFwcGVkU3RhdGljVmFyaWFibGVzID0gYWxsU3RhdGljVmFyaWFibGVzLm1hcChqdXN0V3JhcCkgLSU+CiAgICA8JV8gbGV0IHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZSA9IGFsbFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlLm1hcCh3cmFwTWV0aG9kKS5maWx0ZXIoeyAkMC53cmFwcGVkSW5NZXRob2RUeXBlKCkgfSkgLSU+CiAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFZhcmlhYmxlcyB7IHByb3BlcnR5UmVnaXN0ZXIodmFyaWFibGUpIH0gLSU+CiAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFN0YXRpY1ZhcmlhYmxlcyB7IHByb3BlcnR5UmVnaXN0ZXIodmFyaWFibGUpIH0gLSU+CiAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kcyB7IG1ldGhvZC5yZWdpc3RlcigpIH0gLSU+CiAgICA8JV8gZm9yIHdyYXBwZWQgaW4gd3JhcHBlZFN1YnNjcmlwdHMgeyB3cmFwcGVkLnJlZ2lzdGVyKCkgfSAtJT4KICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzIHsgbWV0aG9kLnJlZ2lzdGVyKCkgfSAtJT48JV8gLSU+CiAgICA8JV8gbGV0IHZhcmlhYmxlQ2FzZXNDb3VudDogSW50ID0gd3JhcHBlZFZhcmlhYmxlcy5yZWR1Y2UoMCkgeyByZXR1cm4gJDAgKyAkMS5jYXNlc0NvdW50IH0gLSU+PCVfIC0lPgogICAgPCVfIGxldCBzdWJzY3JpcHRzQ2FzZXNDb3VudDogSW50ID0gd3JhcHBlZFN1YnNjcmlwdHMucmVkdWNlKDApIHsgcmV0dXJuICQwICsgJDEuY2FzZXNDb3VudCB9IC0lPjwlXyAtJT4KICAgIDwlXyBsZXQgc3RhdGljVmFyaWFibGVDYXNlc0NvdW50OiBJbnQgPSB3cmFwcGVkU3RhdGljVmFyaWFibGVzLnJlZHVjZSgwKSB7IHJldHVybiAkMCArICQxLmNhc2VzQ291bnQgfSAtJT48JV8gLSU+CiAgICA8JV8gbGV0IGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yTWV0aG9kczogQm9vbCA9IGZhbHNlIC0lPjwlXyAtJT4KICAgIDwlXyBsZXQgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JTdGF0aWNNZXRob2RzOiBCb29sID0gZmFsc2UgLSU+PCVfIC0lPgoKICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU1RBVElDIFNUVUJTIC0lPjwlXyAtJT4KICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzIHsgLSU+CiAgICA8JT0gbWV0aG9kLmZ1bmN0aW9uUHJvdG90eXBlIF8lPiB7CiAgICAgICAgPCU9IG1ldGhvZC5zdHViQm9keSgpIF8lPgogICAgfQoKICAgIDwlXyB9ICU+PCVfIC0lPgogICAgPCVfIC0lPgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBJTklUSUFMSVpFUlMgLSU+PCVfIC0lPgogICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZEluaXRpYWxpemVycyB7IC0lPgogICAgPCU9IG1ldGhvZC5mdW5jdGlvblByb3RvdHlwZSBfJT4geyB9CgogICAgPCVfIH0gLSU+PCVfIC0lPgogICAgPCVfIC0lPjwlXyAtJT4KICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU1RVQlMgLSU+PCVfIC0lPgogICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHMgeyAtJT4KICAgIDwlPSBtZXRob2QuZnVuY3Rpb25Qcm90b3R5cGUgXyU+IHsKICAgICAgICA8JT0gbWV0aG9kLnN0dWJCb2R5KCkgXyU+CiAgICB9CgogICAgPCVfIH0gLSU+CiAgICA8JV8gZm9yIHdyYXBwZWQgaW4gd3JhcHBlZFN1YnNjcmlwdHMgeyAtJT4KICAgIDwlPSB3cmFwcGVkLnN1YnNjcmlwdENhbGwoKSBfJT4KCiAgICA8JV8gfSAtJT4KICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU1RBVElDIE1FVEhPRCBUWVBFIC0lPjwlXyAtJT4KICAgIDwlXyBpZiBjb25mb3Jtc1RvU3RhdGljTW9jayB7IC0lPgogICAgZmlsZXByaXZhdGUgZW51bSBTdGF0aWNNZXRob2RUeXBlIHsKICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZSB7IC0lPgogICAgICAgIGNhc2UgPCU9IG1ldGhvZC5tZXRob2RUeXBlRGVjbGFyYXRpb25XaXRoUGFyYW1ldGVycygpIF8lPgogICAgPCVfICB9ICU+IDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsU3RhdGljVmFyaWFibGVzIHsgLSU+CiAgICAgICAgPCU9IHByb3BlcnR5TWV0aG9kVHlwZXModmFyaWFibGUpICU+CiAgICA8JV8gfSAlPiA8JV8gJT4KICAgIDwlXyAtJT4KICAgICAgICBzdGF0aWMgZnVuYyBjb21wYXJlUGFyYW1ldGVycyhsaHM6IFN0YXRpY01ldGhvZFR5cGUsIHJoczogU3RhdGljTWV0aG9kVHlwZSwgbWF0Y2hlcjogTWF0Y2hlcikgLT4gQm9vbCB7CiAgICAgICAgICAgIHN3aXRjaCAobGhzLCByaHMpIHsgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlIHsgJT4KICAgICAgICAgICAgPCU9IG1ldGhvZC5lcXVhbENhc2UgLSU+PCUgZm9yIHBhcmFtZXRlciBpbiBtZXRob2QucGFyYW1ldGVycyB7ICU+CiAgICAgICAgICAgICAgICA8JT0gcGFyYW1ldGVyLmNvbXBhcmF0b3IgLSU+IDwlICB9ICU+CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZSA8JSB9ICU+CiAgICAgICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsU3RhdGljVmFyaWFibGVzIHsgLSU+CiAgICAgICAgICAgIDwlPSBwcm9wZXJ0eU1ldGhvZFR5cGVzQ29tcGFyZSh2YXJpYWJsZSkgJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+IDwlXyBpZiB3cmFwcGVkU3RhdGljTWV0aG9kcy5jb3VudCArIHN0YXRpY1ZhcmlhYmxlQ2FzZXNDb3VudCA+IDEgeyAtJT4KICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlCiAgICAgICAgICAgIDwlXyB9IC0lPgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgPCVfICU+CiAgICAgICAgZnVuYyBpbnRWYWx1ZSgpIC0+IEludCB7CiAgICAgICAgICAgIHN3aXRjaCBzZWxmIHsgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlIHsgJT4KICAgICAgICAgICAgICAgIDwlPSBtZXRob2QuaW50VmFsdWVDYXNlIC0lPjwlIH0gJT4KICAgICAgICAgICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsU3RhdGljVmFyaWFibGVzIHsgLSU+CiAgICAgICAgICAgICAgICA8JT0gcHJvcGVydHlNZXRob2RUeXBlc0ludFZhbHVlKHZhcmlhYmxlKSAlPgogICAgICAgICAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIG9wZW4gY2xhc3MgU3RhdGljR2l2ZW46IFN0dWJiZWRNZXRob2QgewogICAgICAgIGZpbGVwcml2YXRlIHZhciBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUKCiAgICAgICAgcHJpdmF0ZSBpbml0KG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZSwgcHJvZHVjdHM6IFtTdHViUHJvZHVjdF0pIHsKICAgICAgICAgICAgc2VsZi5tZXRob2QgPSBtZXRob2QKICAgICAgICAgICAgc3VwZXIuaW5pdChwcm9kdWN0cykKICAgICAgICB9CgogICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsU3RhdGljVmFyaWFibGVzIHsgLSU+CiAgICAgICAgPCU9IHdyYXBQcm9wZXJ0eSh2YXJpYWJsZSkuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIikgLSU+IHsKICAgICAgICAgICAgPCU9IHdyYXBQcm9wZXJ0eSh2YXJpYWJsZSkuZ2l2ZW5Db25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gJT4gPCVfICU+CiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlLmZpbHRlcih7ICEkMC5tZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkICYmICEkMC5tZXRob2QuaXNJbml0aWFsaXplciB9KSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIikgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JTdGF0aWNNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUuZmlsdGVyKHsgISQwLm1ldGhvZC50aHJvd3MgJiYgISQwLm1ldGhvZC5yZXRocm93cyAmJiAhJDAubWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCAmJiAhJDAubWV0aG9kLmlzSW5pdGlhbGl6ZXIgfSkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUuZmlsdGVyKHsgKCQwLm1ldGhvZC50aHJvd3MgfHwgJDAubWV0aG9kLnJldGhyb3dzKSAmJiAhJDAubWV0aG9kLmlzSW5pdGlhbGl6ZXIgfSkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lVGhyb3dzKHByZWZpeDogIlN0YXRpYyIpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvclRocm93cyhwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yU3RhdGljTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZVRocm93cyhwcmVmaXg6ICJTdGF0aWMiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvclRocm93cyhwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3Rvck5hbWVUaHJvd3MocHJlZml4OiAiU3RhdGljIikgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3RvclRocm93cyhwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgfQoKICAgIHB1YmxpYyBzdHJ1Y3QgU3RhdGljVmVyaWZ5IHsKICAgICAgICBmaWxlcHJpdmF0ZSB2YXIgbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlCgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIikgLSU+IHsgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPiB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yU3RhdGljTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7IDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4gfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFN0YXRpY1ZhcmlhYmxlcyB7IC0lPgogICAgICAgIDwlPSBwcm9wZXJ0eVR5cGVzKHZhcmlhYmxlKSAlPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgIH0KCiAgICBwdWJsaWMgc3RydWN0IFN0YXRpY1BlcmZvcm0gewogICAgICAgIGZpbGVwcml2YXRlIHZhciBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUKICAgICAgICB2YXIgcGVyZm9ybXM6IEFueQoKICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JTdGF0aWNNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgIH0KCiAgICA8JSB9IC0lPgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBNRVRIT0QgVFlQRSAtJT48JV8gLSU+CiAgICA8JV8gaWYgIXdyYXBwZWRNZXRob2RzLmlzRW1wdHkgfHwgIWFsbFZhcmlhYmxlcy5pc0VtcHR5IHx8ICFhbGxTdWJzY3JpcHRzLmlzRW1wdHkgeyAtJT4KCiAgICBmaWxlcHJpdmF0ZSBlbnVtIE1ldGhvZFR5cGUgewogICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlIHsgLSU+CiAgICAgICAgY2FzZSA8JT0gbWV0aG9kLm1ldGhvZFR5cGVEZWNsYXJhdGlvbldpdGhQYXJhbWV0ZXJzKCkgXyU+CiAgICA8JV8gIH0gLSU+IDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsVmFyaWFibGVzIHsgLSU+CiAgICAgICAgPCU9IHByb3BlcnR5TWV0aG9kVHlwZXModmFyaWFibGUpICU+CiAgICA8JV8gfSAlPiA8JV8gJT4gPCVfIGZvciB3cmFwcGVkIGluIHdyYXBwZWRTdWJzY3JpcHRzIHsgLSU+CiAgICAgICAgPCU9IHdyYXBwZWQuc3Vic2NyaXB0Q2FzZXMoKSBfJT4KICAgIDwlXyB9ICU+IDwlXyAlPgogICAgPCVfIC0lPgogICAgICAgIHN0YXRpYyBmdW5jIGNvbXBhcmVQYXJhbWV0ZXJzKGxoczogTWV0aG9kVHlwZSwgcmhzOiBNZXRob2RUeXBlLCBtYXRjaGVyOiBNYXRjaGVyKSAtPiBCb29sIHsKICAgICAgICAgICAgc3dpdGNoIChsaHMsIHJocykgeyA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAlPgogICAgICAgICAgICA8JT0gbWV0aG9kLmVxdWFsQ2FzZSAtJT48JSBmb3IgcGFyYW1ldGVyIGluIG1ldGhvZC5wYXJhbWV0ZXJzIHsgJT4KICAgICAgICAgICAgICAgIDwlPSBwYXJhbWV0ZXIuY29tcGFyYXRvciAtJT4gPCUgIH0gJT4KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlIDwlIH0gJT4KICAgICAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxWYXJpYWJsZXMgeyAtJT4KICAgICAgICAgICAgPCU9IHByb3BlcnR5TWV0aG9kVHlwZXNDb21wYXJlKHZhcmlhYmxlKSAlPgogICAgICAgICAgICA8JV8gfSAlPiA8JV8gLSU+IDwlXyBmb3Igd3JhcHBlZCBpbiB3cmFwcGVkU3Vic2NyaXB0cyB7IC0lPgogICAgICAgICAgICA8JT0gd3JhcHBlZC5lcXVhbENhc2VzKCkgJT4KICAgICAgICA8JV8gfSAlPiA8JV8gaWYgd3JhcHBlZE1ldGhvZHMuY291bnQgKyB2YXJpYWJsZUNhc2VzQ291bnQgKyBzdWJzY3JpcHRzQ2FzZXNDb3VudCA+IDEgeyAtJT4KICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlCiAgICAgICAgICAgIDwlXyB9IC0lPgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgPCVfICU+CiAgICAgICAgZnVuYyBpbnRWYWx1ZSgpIC0+IEludCB7CiAgICAgICAgICAgIHN3aXRjaCBzZWxmIHsgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlIHsgJT4KICAgICAgICAgICAgPCU9IG1ldGhvZC5pbnRWYWx1ZUNhc2UgLSU+PCUgfSAlPgogICAgICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFZhcmlhYmxlcyB7IC0lPgogICAgICAgICAgICA8JT0gcHJvcGVydHlNZXRob2RUeXBlc0ludFZhbHVlKHZhcmlhYmxlKSAlPgogICAgICAgICAgICA8JV8gfSAlPiA8JV8gZm9yIHdyYXBwZWQgaW4gd3JhcHBlZFN1YnNjcmlwdHMgeyAtJT4KICAgICAgICAgICAgPCU9IHdyYXBwZWQuaW50VmFsdWVDYXNlKCkgJT4KICAgICAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICA8JV8gfSBlbHNlIHsgJT4KICAgIGZpbGVwcml2YXRlIHN0cnVjdCBNZXRob2RUeXBlIHsKICAgICAgICBzdGF0aWMgZnVuYyBjb21wYXJlUGFyYW1ldGVycyhsaHM6IE1ldGhvZFR5cGUsIHJoczogTWV0aG9kVHlwZSwgbWF0Y2hlcjogTWF0Y2hlcikgLT4gQm9vbCB7IHJldHVybiB0cnVlIH0KICAgICAgICBmdW5jIGludFZhbHVlKCkgLT4gSW50IHsgcmV0dXJuIDAgfQogICAgfQogICAgPCVfIH0gLSU+PCVfIC0lPgoKICAgIG9wZW4gY2xhc3MgR2l2ZW46IFN0dWJiZWRNZXRob2QgewogICAgICAgIGZpbGVwcml2YXRlIHZhciBtZXRob2Q6IE1ldGhvZFR5cGUKCiAgICAgICAgcHJpdmF0ZSBpbml0KG1ldGhvZDogTWV0aG9kVHlwZSwgcHJvZHVjdHM6IFtTdHViUHJvZHVjdF0pIHsKICAgICAgICAgICAgc2VsZi5tZXRob2QgPSBtZXRob2QKICAgICAgICAgICAgc3VwZXIuaW5pdChwcm9kdWN0cykKICAgICAgICB9CgogICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsVmFyaWFibGVzIHsgLSU+CiAgICAgICAgPCU9IHdyYXBQcm9wZXJ0eSh2YXJpYWJsZSkuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUoKSAtJT4gewogICAgICAgICAgICA8JT0gd3JhcFByb3BlcnR5KHZhcmlhYmxlKS5naXZlbkNvbnN0cnVjdG9yKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9ICU+IDwlXyAlPgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZS5maWx0ZXIoeyAhJDAubWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCAmJiAhJDAubWV0aG9kLmlzSW5pdGlhbGl6ZXIgfSkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lKCkgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0Zvck1ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3IoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlLmZpbHRlcih7ICEkMC5tZXRob2QudGhyb3dzICYmICEkMC5tZXRob2QucmV0aHJvd3MgJiYgISQwLm1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgJiYgISQwLm1ldGhvZC5pc0luaXRpYWxpemVyIH0pIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3Rvck5hbWUoKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyBmb3Igd3JhcHBlZCBpbiB3cmFwcGVkU3Vic2NyaXB0cyB7IC0lPgogICAgICAgIDwlPSB3cmFwcGVkLmdpdmVuQ29uc3RydWN0b3JOYW1lKCkgLSU+IHsKICAgICAgICAgICAgPCU9IHdyYXBwZWQuZ2l2ZW5Db25zdHJ1Y3RvcigpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUuZmlsdGVyKHsgKCQwLm1ldGhvZC50aHJvd3MgfHwgJDAubWV0aG9kLnJldGhyb3dzKSAmJiAhJDAubWV0aG9kLmlzSW5pdGlhbGl6ZXIgfSkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lVGhyb3dzKCkgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yVGhyb3dzKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0Zvck1ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWVUaHJvd3MocHJlZml4OiAiIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JUaHJvd3MoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3Rvck5hbWVUaHJvd3MoKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yVGhyb3dzKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgIH0KCiAgICBwdWJsaWMgc3RydWN0IFZlcmlmeSB7CiAgICAgICAgZmlsZXByaXZhdGUgdmFyIG1ldGhvZDogTWV0aG9kVHlwZQoKICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3JOYW1lKCkgLSU+IHsgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yKCkgXyU+IH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogIiIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yKCkgXyU+IH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxWYXJpYWJsZXMgeyAtJT4KICAgICAgICA8JT0gcHJvcGVydHlUeXBlcyh2YXJpYWJsZSkgJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICAgICAgPCVfIGZvciB3cmFwcGVkIGluIHdyYXBwZWRTdWJzY3JpcHRzIHsgLSU+CiAgICAgICAgPCU9IHdyYXBwZWQudmVyaWZ5Q29uc3RydWN0b3JOYW1lKCkgLSU+IHsgPCU9IHdyYXBwZWQudmVyaWZ5Q29uc3RydWN0b3IoKSBfJT4gfQogICAgICAgIDwlXyBpZiAhd3JhcHBlZC5yZWFkb25seSB7IC0lPgogICAgICAgIDwlPSB3cmFwcGVkLnZlcmlmeUNvbnN0cnVjdG9yTmFtZShzZXQ6IHRydWUpIC0lPiB7IDwlPSB3cmFwcGVkLnZlcmlmeUNvbnN0cnVjdG9yKHNldDogdHJ1ZSkgXyU+IH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICB9CgogICAgcHVibGljIHN0cnVjdCBQZXJmb3JtIHsKICAgICAgICBmaWxlcHJpdmF0ZSB2YXIgbWV0aG9kOiBNZXRob2RUeXBlCiAgICAgICAgdmFyIHBlcmZvcm1zOiBBbnkKCiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3Rvck5hbWUoKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0Zvck1ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogIiIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3RvcigpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICB9CgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBNT0NLIE1FVEhPRFMgLSU+PCVfIC0lPgogICAgcHVibGljIGZ1bmMgZ2l2ZW4oXyBtZXRob2Q6IEdpdmVuKSB7CiAgICAgICAgbWV0aG9kUmV0dXJuVmFsdWVzLmFwcGVuZChtZXRob2QpCiAgICB9CgogICAgcHVibGljIGZ1bmMgcGVyZm9ybShfIG1ldGhvZDogUGVyZm9ybSkgewogICAgICAgIG1ldGhvZFBlcmZvcm1WYWx1ZXMuYXBwZW5kKG1ldGhvZCkKICAgICAgICBtZXRob2RQZXJmb3JtVmFsdWVzLnNvcnQgeyAkMC5tZXRob2QuaW50VmFsdWUoKSA8ICQxLm1ldGhvZC5pbnRWYWx1ZSgpIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuYyB2ZXJpZnkoXyBtZXRob2Q6IFZlcmlmeSwgY291bnQ6IENvdW50ID0gQ291bnQubW9yZU9yRXF1YWwodG86IDEpLCBmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgbGV0IGludm9jYXRpb25zID0gbWF0Y2hpbmdDYWxscyhtZXRob2QubWV0aG9kKQogICAgICAgIE1vY2t5QXNzZXJ0KGNvdW50Lm1hdGNoZXMoaW52b2NhdGlvbnMuY291bnQpLCAiRXhwZWN0ZWQ6IFwoY291bnQpIGludm9jYXRpb25zIG9mIGBcKG1ldGhvZC5tZXRob2QpYCwgYnV0IHdhczogXChpbnZvY2F0aW9ucy5jb3VudCkiLCBmaWxlOiBmaWxlLCBsaW5lOiBsaW5lKQogICAgfQoKICAgIHByaXZhdGUgZnVuYyBhZGRJbnZvY2F0aW9uKF8gY2FsbDogTWV0aG9kVHlwZSkgewogICAgICAgIGludm9jYXRpb25zLmFwcGVuZChjYWxsKQogICAgfQogICAgcHJpdmF0ZSBmdW5jIG1ldGhvZFJldHVyblZhbHVlKF8gbWV0aG9kOiBNZXRob2RUeXBlKSB0aHJvd3MgLT4gU3R1YlByb2R1Y3QgewogICAgICAgIGxldCBjYW5kaWRhdGVzID0gc2VxdWVuY2luZ1BvbGljeS5zb3J0ZWQobWV0aG9kUmV0dXJuVmFsdWVzLCBieTogeyAkMC5tZXRob2QuaW50VmFsdWUoKSA+ICQxLm1ldGhvZC5pbnRWYWx1ZSgpIH0pCiAgICAgICAgbGV0IG1hdGNoZWQgPSBjYW5kaWRhdGVzLmZpcnN0KHdoZXJlOiB7ICQwLmlzVmFsaWQgJiYgTWV0aG9kVHlwZS5jb21wYXJlUGFyYW1ldGVycyhsaHM6ICQwLm1ldGhvZCwgcmhzOiBtZXRob2QsIG1hdGNoZXI6IG1hdGNoZXIpIH0pCiAgICAgICAgZ3VhcmQgbGV0IHByb2R1Y3QgPSBtYXRjaGVkPy5nZXRQcm9kdWN0KHBvbGljeTogc2VsZi5zdHViYmluZ1BvbGljeSkgZWxzZSB7IHRocm93IE1vY2tFcnJvci5ub3RTdHViZWQgfQogICAgICAgIHJldHVybiBwcm9kdWN0CiAgICB9CiAgICBwcml2YXRlIGZ1bmMgbWV0aG9kUGVyZm9ybVZhbHVlKF8gbWV0aG9kOiBNZXRob2RUeXBlKSAtPiBBbnk/IHsKICAgICAgICBsZXQgbWF0Y2hlZCA9IG1ldGhvZFBlcmZvcm1WYWx1ZXMucmV2ZXJzZWQoKS5maXJzdCB7IE1ldGhvZFR5cGUuY29tcGFyZVBhcmFtZXRlcnMobGhzOiAkMC5tZXRob2QsIHJoczogbWV0aG9kLCBtYXRjaGVyOiBtYXRjaGVyKSB9CiAgICAgICAgcmV0dXJuIG1hdGNoZWQ/LnBlcmZvcm1zCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgbWF0Y2hpbmdDYWxscyhfIG1ldGhvZDogTWV0aG9kVHlwZSkgLT4gW01ldGhvZFR5cGVdIHsKICAgICAgICByZXR1cm4gaW52b2NhdGlvbnMuZmlsdGVyIHsgTWV0aG9kVHlwZS5jb21wYXJlUGFyYW1ldGVycyhsaHM6ICQwLCByaHM6IG1ldGhvZCwgbWF0Y2hlcjogbWF0Y2hlcikgfQogICAgfQogICAgcHJpdmF0ZSBmdW5jIG1hdGNoaW5nQ2FsbHMoXyBtZXRob2Q6IFZlcmlmeSkgLT4gSW50IHsKICAgICAgICByZXR1cm4gbWF0Y2hpbmdDYWxscyhtZXRob2QubWV0aG9kKS5jb3VudAogICAgfQogICAgcHJpdmF0ZSBmdW5jIGdpdmVuR2V0dGVyVmFsdWU8VD4oXyBtZXRob2Q6IE1ldGhvZFR5cGUsIF8gbWVzc2FnZTogU3RyaW5nKSAtPiBUIHsKICAgICAgICBkbyB7CiAgICAgICAgICAgIHJldHVybiB0cnkgbWV0aG9kUmV0dXJuVmFsdWUobWV0aG9kKS5jYXN0ZWQoKQogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICBvbkZhdGFsRmFpbHVyZShtZXNzYWdlKQogICAgICAgICAgICBGYWlsdXJlKG1lc3NhZ2UpCiAgICAgICAgfQogICAgfQogICAgcHJpdmF0ZSBmdW5jIG9wdGlvbmFsR2l2ZW5HZXR0ZXJWYWx1ZTxUPihfIG1ldGhvZDogTWV0aG9kVHlwZSwgXyBtZXNzYWdlOiBTdHJpbmcpIC0+IFQ/IHsKICAgICAgICBkbyB7CiAgICAgICAgICAgIHJldHVybiB0cnkgbWV0aG9kUmV0dXJuVmFsdWUobWV0aG9kKS5jYXN0ZWQoKQogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICByZXR1cm4gbmlsCiAgICAgICAgfQogICAgfQogICAgcHJpdmF0ZSBmdW5jIG9uRmF0YWxGYWlsdXJlKF8gbWVzc2FnZTogU3RyaW5nKSB7CiAgICAgICAgI2lmIE1vY2t5CiAgICAgICAgZ3VhcmQgbGV0IGZpbGUgPSBzZWxmLmZpbGUsIGxldCBsaW5lID0gc2VsZi5saW5lIGVsc2UgeyByZXR1cm4gfSAvLyBMZXQgaWYgZmFpbCBpZiBjYW5ub3QgaGFuZGxlIGdyYXRlZnVsbHkKICAgICAgICBTd2lmdHlNb2NreVRlc3RPYnNlcnZlci5oYW5kbGVNaXNzaW5nU3R1YkVycm9yKG1lc3NhZ2U6IG1lc3NhZ2UsIGZpbGU6IGZpbGUsIGxpbmU6IGxpbmUpCiAgICAgICAgI2VuZGlmCiAgICB9CiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFNUQVRJQyBNT0NLIE1FVEhPRFMgLSU+PCVfIC0lPgogICAgPCVfIGlmIGNvbmZvcm1zVG9TdGF0aWNNb2NrIHsgLSU+CgogICAgc3RhdGljIHB1YmxpYyBmdW5jIGdpdmVuKF8gbWV0aG9kOiBTdGF0aWNHaXZlbikgewogICAgICAgIG1ldGhvZFJldHVyblZhbHVlcy5hcHBlbmQobWV0aG9kKQogICAgfQoKICAgIHN0YXRpYyBwdWJsaWMgZnVuYyBwZXJmb3JtKF8gbWV0aG9kOiBTdGF0aWNQZXJmb3JtKSB7CiAgICAgICAgbWV0aG9kUGVyZm9ybVZhbHVlcy5hcHBlbmQobWV0aG9kKQogICAgICAgIG1ldGhvZFBlcmZvcm1WYWx1ZXMuc29ydCB7ICQwLm1ldGhvZC5pbnRWYWx1ZSgpIDwgJDEubWV0aG9kLmludFZhbHVlKCkgfQogICAgfQoKICAgIHN0YXRpYyBwdWJsaWMgZnVuYyB2ZXJpZnkoXyBtZXRob2Q6IFN0YXRpY1ZlcmlmeSwgY291bnQ6IENvdW50ID0gQ291bnQubW9yZU9yRXF1YWwodG86IDEpLCBmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgbGV0IGludm9jYXRpb25zID0gbWF0Y2hpbmdDYWxscyhtZXRob2QubWV0aG9kKQogICAgICAgIE1vY2t5QXNzZXJ0KGNvdW50Lm1hdGNoZXMoaW52b2NhdGlvbnMuY291bnQpLCAiRXhwZWN0ZWQ6IFwoY291bnQpIGludm9jYXRpb25zIG9mIGBcKG1ldGhvZC5tZXRob2QpYCwgYnV0IHdhczogXChpbnZvY2F0aW9ucy5jb3VudCkiLCBmaWxlOiBmaWxlLCBsaW5lOiBsaW5lKQogICAgfQoKICAgIHN0YXRpYyBwcml2YXRlIGZ1bmMgYWRkSW52b2NhdGlvbihfIGNhbGw6IFN0YXRpY01ldGhvZFR5cGUpIHsKICAgICAgICBpbnZvY2F0aW9ucy5hcHBlbmQoY2FsbCkKICAgIH0KICAgIHN0YXRpYyBwcml2YXRlIGZ1bmMgbWV0aG9kUmV0dXJuVmFsdWUoXyBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUpIHRocm93cyAtPiBTdHViUHJvZHVjdCB7CiAgICAgICAgbGV0IGNhbmRpZGF0ZXMgPSBzZXF1ZW5jaW5nUG9saWN5LnNvcnRlZChtZXRob2RSZXR1cm5WYWx1ZXMsIGJ5OiB7ICQwLm1ldGhvZC5pbnRWYWx1ZSgpID4gJDEubWV0aG9kLmludFZhbHVlKCkgfSkKICAgICAgICBsZXQgbWF0Y2hlZCA9IGNhbmRpZGF0ZXMuZmlyc3Qod2hlcmU6IHsgJDAuaXNWYWxpZCAmJiBTdGF0aWNNZXRob2RUeXBlLmNvbXBhcmVQYXJhbWV0ZXJzKGxoczogJDAubWV0aG9kLCByaHM6IG1ldGhvZCwgbWF0Y2hlcjogbWF0Y2hlcikgfSkKICAgICAgICBndWFyZCBsZXQgcHJvZHVjdCA9IG1hdGNoZWQ/LmdldFByb2R1Y3QocG9saWN5OiBzZWxmLnN0dWJiaW5nUG9saWN5KSBlbHNlIHsgdGhyb3cgTW9ja0Vycm9yLm5vdFN0dWJlZCB9CiAgICAgICAgcmV0dXJuIHByb2R1Y3QKICAgIH0KICAgIHN0YXRpYyBwcml2YXRlIGZ1bmMgbWV0aG9kUGVyZm9ybVZhbHVlKF8gbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlKSAtPiBBbnk/IHsKICAgICAgICBsZXQgbWF0Y2hlZCA9IG1ldGhvZFBlcmZvcm1WYWx1ZXMucmV2ZXJzZWQoKS5maXJzdCB7IFN0YXRpY01ldGhvZFR5cGUuY29tcGFyZVBhcmFtZXRlcnMobGhzOiAkMC5tZXRob2QsIHJoczogbWV0aG9kLCBtYXRjaGVyOiBtYXRjaGVyKSB9CiAgICAgICAgcmV0dXJuIG1hdGNoZWQ/LnBlcmZvcm1zCiAgICB9CiAgICBzdGF0aWMgcHJpdmF0ZSBmdW5jIG1hdGNoaW5nQ2FsbHMoXyBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUpIC0+IFtTdGF0aWNNZXRob2RUeXBlXSB7CiAgICAgICAgcmV0dXJuIGludm9jYXRpb25zLmZpbHRlciB7IFN0YXRpY01ldGhvZFR5cGUuY29tcGFyZVBhcmFtZXRlcnMobGhzOiAkMCwgcmhzOiBtZXRob2QsIG1hdGNoZXI6IG1hdGNoZXIpIH0KICAgIH0KICAgIHN0YXRpYyBwcml2YXRlIGZ1bmMgbWF0Y2hpbmdDYWxscyhfIG1ldGhvZDogU3RhdGljVmVyaWZ5KSAtPiBJbnQgewogICAgICAgIHJldHVybiBtYXRjaGluZ0NhbGxzKG1ldGhvZC5tZXRob2QpLmNvdW50CiAgICB9CiAgICBzdGF0aWMgcHJpdmF0ZSBmdW5jIGdpdmVuR2V0dGVyVmFsdWU8VD4oXyBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUsIF8gbWVzc2FnZTogU3RyaW5nKSAtPiBUIHsKICAgICAgICBkbyB7CiAgICAgICAgICAgIHJldHVybiB0cnkgbWV0aG9kUmV0dXJuVmFsdWUobWV0aG9kKS5jYXN0ZWQoKQogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICBGYWlsdXJlKG1lc3NhZ2UpCiAgICAgICAgfQogICAgfQogICAgc3RhdGljIHByaXZhdGUgZnVuYyBvcHRpb25hbEdpdmVuR2V0dGVyVmFsdWU8VD4oXyBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUsIF8gbWVzc2FnZTogU3RyaW5nKSAtPiBUPyB7CiAgICAgICAgZG8gewogICAgICAgICAgICByZXR1cm4gdHJ5IG1ldGhvZFJldHVyblZhbHVlKG1ldGhvZCkuY2FzdGVkKCkKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgcmV0dXJuIG5pbAogICAgICAgIH0KICAgIH0KICAgIDwlXyB9IC0lPgo8JV8gaWYgYXV0b01vY2thYmxlIHsgLSU+Cn0KCjwlXyB9IGVsc2UgeyAtJT4KLy8gc291cmNlcnk6ZW5kCjwlXyB9IC0lPgo8JSB9IC0lPgo8JV8gaWYgbW9ja2VkQ291bnQgPT0gMCB7IC0lPgovLyBTd2lmdHlNb2NreTogbm8gQXV0b01vY2thYmxlIGZvdW5kLgovLyBQbGVhc2UgZGVmaW5lIGFuZCBpbmhlcml0IGZyb20gQXV0b01vY2thYmxlLCBvciBhbm5vdGF0ZSBwcm90b2NvbHMgdG8gYmUgbW9ja2VkCjwlXyB9IC0lPg=="
    )
}
